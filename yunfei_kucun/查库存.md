1.遍历所有 含属性rowid的tr标签，找到内容含SKU的span的下一个span的div.span ，获得这个span的值就是sku_value，去除前后空格。

2.在这个tr标签的上一个tr标签 的.left 元素后增加一个按钮 “查看库存”

2.点击查看库存，通过POST请求 https://erp.lingxing.com/api/storage/lists  ，携带下面参数中替换sku的值。

```javascript
{"wid_list":"","mid_list":"","sid_list":"","cid_list":"","bid_list":"","principal_list":"","product_type_list":"","product_attribute":"","product_status":"","search_field":"sku","search_value":"NI-C6-SP-CF","is_sku_merge_show":0,"is_hide_zero_stock":0,"offset":0,"length":20,"sort_field":"","sort_type":"","gtag_ids":"","senior_search_list":"[{\"name\":\"SKU\",\"search_field\":\"sku\",\"search_value\":[\"{sku_value}\"]}]","permission_uid_list":"","country_code_list":"","req_time_sequence":"/api/storage/lists$$7"}
```

```javascript
const getAuthToken = () => (document.cookie.match(/auth-token=([^;]+)/) || [])[1] || null;
const auth_token = getAuthToken();

header_data = {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, deflate, br, zstd",
        "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
        "ak-client-type": "web",
        "ak-origin": "https://erp.lingxing.com",
        "auth-token": auth_token,
        "content-length": "688",
        "content-type": "application/json;charset=UTF-8",
        "origin": "https://erp.lingxing.com",
        "priority": "u=1, i",
        "referer": "https://erp.lingxing.com/",
        "sec-ch-ua": "\"Chromium\";v=\"135\", \"Not-A.Brand\";v=\"8\"",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "\"Windows\"",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "cross-site",
        "sec-fetch-storage-access": "active",
        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
        "x-ak-company-id": "901571037510692352",
        "x-ak-env-key": "SAAS-126",
        "x-ak-language": "zh",
        "x-ak-platform": "1",
        "x-ak-request-id": "357c8014-0c07-4728-be2b-82b18f9e4a4c",
        "x-ak-request-source": "erp",
        "x-ak-uid": "10956565",
        "x-ak-version": "3.7.2.3.0.095",
        "x-ak-zid": "10796914"
    };
```

4.请求结果为json， 遍历 data.list，取值 wh_name，total，average_age ，按average_age降序处理为新数组,弹窗展示数组



以下是针对单斜杠转义的完整实现代码，确保`senior_search_list`参数中的特殊字符（包括单斜杠）都能正确转义：

```javascript
// 获取认证token
const getAuthToken = () => (document.cookie.match(/auth-token=([^;]+)/) || [])[1] || null;
const auth_token = getAuthToken();

// 请求头配置
const header_data = {
    "accept": "application/json, text/plain, */*",
    "accept-encoding": "gzip, deflate, br, zstd",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
    "ak-client-type": "web",
    "ak-origin": "https://erp.lingxing.com",
    "auth-token": auth_token,
    "content-type": "application/json;charset=UTF-8",
    "origin": "https://erp.lingxing.com",
    "priority": "u=1, i",
    "referer": "https://erp.lingxing.com/",
    "sec-ch-ua": "\"Chromium\";v=\"135\", \"Not-A.Brand\";v=\"8\"",
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": "\"Windows\"",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "cross-site",
    "sec-fetch-storage-access": "active",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
    "x-ak-company-id": "901571037510692352",
    "x-ak-env-key": "SAAS-126",
    "x-ak-language": "zh",
    "x-ak-platform": "1",
    "x-ak-request-id": "357c8014-0c07-4728-be2b-82b18f9e4a4c",
    "x-ak-request-source": "erp",
    "x-ak-uid": "10956565",
    "x-ak-version": "3.7.2.3.0.095",
    "x-ak-zid": "10796914"
};

// 格式化展示数据
const formatInventoryData = (dataList) => {
    // 按average_age降序排序
    const sortedList = dataList.sort((a, b) => b.average_age - a.average_age);
    
    // 格式化输出内容
    let content = "库存信息（按平均库龄降序）：\n\n";
    sortedList.forEach((item, index) => {
        content += `${index + 1}. 仓库：${item.wh_name || '未知'}\n`;
        content += `   库存总量：${item.total || 0}\n`;
        content += `   平均库龄：${item.average_age || 0}天\n\n`;
    });
    
    return content;
};

// 单斜杠转义处理函数
const escapeSlashes = (str) => {
    // 转义单斜杠为双斜杠，同时处理其他特殊字符
    return str.replace(/\\/g, '\\\\')  // 转义反斜杠
              .replace(/"/g, '\\"')    // 转义双引号
              .replace(/'/g, "\\'")    // 转义单引号
              .replace(/\//g, '\\/');  // 转义正斜杠
};

// 发送库存查询请求
const fetchInventory = async (skuValue) => {
    try {
        // 对SKU值进行单斜杠转义处理
        const escapedSku = escapeSlashes(skuValue);
        
        // 构建高级搜索列表（手动转义方式）
        const seniorSearchList = `[{\"name\":\"SKU\",\"search_field\":\"sku\",\"search_value\":[\"${escapedSku}\"]}]`;
        
        // 构建请求参数
        const requestData = {
            "wid_list": "",
            "mid_list": "",
            "sid_list": "",
            "cid_list": "",
            "bid_list": "",
            "principal_list": "",
            "product_type_list": "",
            "product_attribute": "",
            "product_status": "",
            "search_field": "sku",
            "search_value": skuValue,
            "is_sku_merge_show": 0,
            "is_hide_zero_stock": 0,
            "offset": 0,
            "length": 20,
            "sort_field": "",
            "sort_type": "",
            "gtag_ids": "",
            "senior_search_list": seniorSearchList, // 使用手动转义的字符串
            "permission_uid_list": "",
            "country_code_list": "",
            "req_time_sequence": "/api/storage/lists$$7"
        };
        
        console.log('请求参数:', requestData);
        
        // 发送POST请求
        const response = await fetch('https://erp.lingxing.com/api/storage/lists', {
            method: 'POST',
            headers: header_data,
            body: JSON.stringify(requestData),
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`请求失败：${response.status}`);
        }
        
        const result = await response.json();
        
        // 处理返回数据
        if (result.data && result.data.list && result.data.list.length > 0) {
            const formattedContent = formatInventoryData(result.data.list);
            alert(formattedContent);
        } else {
            alert(`未找到SKU【${skuValue}】的库存数据`);
        }
        
    } catch (error) {
        console.error('库存查询失败:', error);
        alert(`查询失败：${error.message}\n请检查网络或权限`);
    }
};

// 主处理逻辑
const processElements = () => {
    // 获取所有含rowid属性的tr标签
    const trList = document.querySelectorAll('tr[rowid]');

    trList.forEach(tr => {
        // 查找内容含SKU的span
        const skuSpans = tr.querySelectorAll('span');
        let targetSpan = null;
        
        for (const span of skuSpans) {
            if (span.textContent.includes('SKU')) {
                const nextSpan = span.nextElementSibling;
                if (nextSpan && nextSpan.tagName === 'SPAN') {
                    targetSpan = nextSpan.querySelector('div > span');
                }
                break;
            }
        }
        
        if (targetSpan) {
            const skuValue = targetSpan.textContent.trim();
            console.log('SKU对应的值:', skuValue);
            
            // 找到上一个tr的.left元素，添加按钮
            const prevTr = tr.previousElementSibling;
            if (prevTr) {
                const leftElement = prevTr.querySelector('.left');
                if (leftElement) {
                    // 避免重复添加按钮
                    if (!leftElement.querySelector('.inventory-btn')) {
                        const button = document.createElement('button');
                        button.className = 'inventory-btn';
                        button.textContent = '查看库存';
                        button.style.marginLeft = '8px';
                        button.style.padding = '4px 8px';
                        button.style.cursor = 'pointer';
                        button.style.backgroundColor = '#409eff';
                        button.style.color = 'white';
                        button.style.border = 'none';
                        button.style.borderRadius = '4px';
                        button.style.fontSize = '12px';
                        
                        // 绑定点击事件
                        button.addEventListener('click', function() {
                            fetchInventory(skuValue);
                        });
                        
                        leftElement.appendChild(button); // 添加到.left内部
                    }
                }
            }
        }
    });
};

// 执行处理
processElements();

// 如果页面是动态加载的，可以添加监听
// 例如监听DOM变化，自动重新处理
const observer = new MutationObserver((mutations) => {
    let shouldProcess = false;
    mutations.forEach(mutation => {
        if (mutation.addedNodes.length) {
            shouldProcess = true;
        }
    });
    if (shouldProcess) {
        processElements();
    }
});

// 启动观察者（根据需要启用）
// observer.observe(document.body, { childList: true, subtree: true });
```

### 单斜杠转义处理说明：

1. **专门的转义函数**：`escapeSlashes()`函数专门处理各种斜杠和特殊字符：
   - `replace(/\\/g, '\\\\')`：将反斜杠`\`转义为`\\`
   - `replace(/\//g, '\\/')`：将正斜杠`/`转义为`\/`
   - 同时处理双引号和单引号的转义

2. **手动构建JSON字符串**：
   - 使用反引号`` ` ``包裹字符串，避免嵌套引号问题
   - 手动添加单斜杠转义，确保最终的JSON字符串格式正确

3. **转义效果示例**：
   - 原始SKU：`NI/C6\SP-CF`
   - 转义后：`NI\/C6\\SP-CF`
   - 最终在请求中：`"search_value":["NI\\/C6\\\\SP-CF"]`

4. **备选方案（双重JSON.stringify）**：
   ```javascript
   // 双重JSON.stringify方式
   const seniorSearchObj = [{
       "name": "SKU",
       "search_field": "sku",
       "search_value": [skuValue]
   }];
   const seniorSearchList = JSON.stringify(JSON.stringify(seniorSearchObj));
   ```

### 注意事项：
- 不同的后端系统对转义的要求可能不同，需要根据实际情况调整转义策略
- 手动转义方式比自动转义更可控，适合需要精确控制单斜杠转义的场景
- 代码中添加了`console.log('请求参数:', requestData)`方便调试查看最终的转义结果

如果需要调整转义规则，可以修改`escapeSlashes()`函数中的正则表达式。

以下是完整实现代码，包含POST请求、数据处理和弹窗展示功能：

```javascript
// 获取认证token
const getAuthToken = () => (document.cookie.match(/auth-token=([^;]+)/) || [])[1] || null;
const auth_token = getAuthToken();

// 请求头配置
const header_data = {
    "accept": "application/json, text/plain, */*",
    "accept-encoding": "gzip, deflate, br, zstd",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
    "ak-client-type": "web",
    "ak-origin": "https://erp.lingxing.com",
    "auth-token": auth_token,
    "baggage":"sentry-environment=production,sentry-release=3.7.2.3,sentry-public_key=28008da1850ea166e3c367cfa8a606fa,sentry-trace_id=50ce9f8c721148cfaf518100a0524316,sentry-transaction=%2Fmsupply%2FwarehouseDetail,sentry-sampled=false,sentry-sample_rand=0.36155008537600897,sentry-sample_rate=0",
    "content-type": "application/json;charset=UTF-8",
    "origin": "https://erp.lingxing.com",
    "priority": "u=1, i",
    "referer": "https://erp.lingxing.com/",
    "sec-ch-ua": "\"Chromium\";v=\"135\", \"Not-A.Brand\";v=\"8\"",
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": "\"Windows\"",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "cross-site",
    "sec-fetch-storage-access": "active",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
    "x-ak-company-id": "901571037510692352",
    "x-ak-env-key": "SAAS-126",
    "x-ak-language": "zh",
    "x-ak-platform": "1",
    "x-ak-request-id": "357c8014-0c07-4728-be2b-82b18f9e4a4c",
    "x-ak-request-source": "erp",
    "x-ak-uid": "10956565",
    "x-ak-version": "3.7.2.3.0.095",
    "x-ak-zid": "10796914"
};

// 格式化展示数据
const formatInventoryData = (dataList) => {
    // 按average_age降序排序
    const sortedList = dataList.sort((a, b) => b.average_age - a.average_age);
    
    // 格式化输出内容
    let content = "库存信息（按平均库龄降序）：\n\n";
    sortedList.forEach((item, index) => {
        content += `${index + 1}. 仓库：${item.wh_name || '未知'}\n`;
        content += `   库存总量：${item.total || 0}\n`;
        content += `   平均库龄：${item.average_age || 0}天\n\n`;
    });
    
    return content;
};

// 发送库存查询请求
const fetchInventory = async (skuValue) => {
    try {
        // 构建请求参数
        const requestData = {
            "wid_list": "",
            "mid_list": "",
            "sid_list": "",
            "cid_list": "",
            "bid_list": "",
            "principal_list": "",
            "product_type_list": "",
            "product_attribute": "",
            "product_status": "",
            "search_field": "sku",
            "search_value": skuValue,
            "is_sku_merge_show": 0,
            "is_hide_zero_stock": 0,
            "offset": 0,
            "length": 20,
            "sort_field": "",
            "sort_type": "",
            "gtag_ids": "",
            "senior_search_list": [{"name":"SKU","search_field":"sku","search_value":[skuValue]}],
            "permission_uid_list": "",
            "country_code_list": "",
            "req_time_sequence": "/api/storage/lists$$7"
        };
        
        // 发送POST请求
        const response = await fetch('https://erp.lingxing.com/api/storage/lists', {
            method: 'POST',
            headers: header_data,
            body: JSON.stringify(requestData),
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`请求失败：${response.status}`);
        }
        
        const result = await response.json();
        
        // 处理返回数据
        if (result.data && result.data.list && result.data.list.length > 0) {
            const formattedContent = formatInventoryData(result.data.list);
            alert(formattedContent);
        } else {
            alert(`未找到SKU【${skuValue}】的库存数据`);
        }
        
    } catch (error) {
        console.error('库存查询失败:', error);
        alert(`查询失败：${error.message}\n请检查网络或权限`);
    }
};

// 主处理逻辑
const processElements = () => {
    // 获取所有含rowid属性的tr标签
    const trList = document.querySelectorAll('tr[rowid]');

    trList.forEach(tr => {
        // 查找内容含SKU的span
        const skuSpans = tr.querySelectorAll('span');
        let targetSpan = null;
        
        for (const span of skuSpans) {
            if (span.textContent.includes('SKU')) {
                const nextSpan = span.nextElementSibling;
                if (nextSpan && nextSpan.tagName === 'SPAN') {
                    targetSpan = nextSpan.querySelector('div > span');
                }
                break;
            }
        }
        
        if (targetSpan) {
            const skuValue = targetSpan.textContent.trim();
            console.log('SKU对应的值:', skuValue);
            
            // 找到上一个tr的.left元素，添加按钮
            const prevTr = tr.previousElementSibling;
            if (prevTr) {
                const leftElement = prevTr.querySelector('.left');
                if (leftElement) {
                    // 避免重复添加按钮
                    if (!leftElement.querySelector('.inventory-btn')) {
                        const button = document.createElement('button');
                        button.className = 'inventory-btn';
                        button.textContent = '查看库存';
                        button.style.marginLeft = '8px';
                        button.style.padding = '4px 8px';
                        button.style.cursor = 'pointer';
                        button.style.backgroundColor = '#409eff';
                        button.style.color = 'white';
                        button.style.border = 'none';
                        button.style.borderRadius = '4px';
                        button.style.fontSize = '12px';
                        
                        // 绑定点击事件
                        button.addEventListener('click', function() {
                            fetchInventory(skuValue);
                        });
                        
                        leftElement.appendChild(button); // 添加到.left内部
                    }
                }
            }
        }
    });
};

// 执行处理
processElements();

// 如果页面是动态加载的，可以添加监听
// 例如监听DOM变化，自动重新处理
const observer = new MutationObserver((mutations) => {
    let shouldProcess = false;
    mutations.forEach(mutation => {
        if (mutation.addedNodes.length) {
            shouldProcess = true;
        }
    });
    if (shouldProcess) {
        processElements();
    }
});

// 启动观察者（根据需要启用）
// observer.observe(document.body, { childList: true, subtree: true });
```

### 功能说明：
1. **元素遍历与SKU提取**：遍历含`rowid`属性的`tr`标签，找到SKU对应的数值并去除空格
2. **按钮添加**：在上一个`tr`的`.left`元素后添加样式美观的"查看库存"按钮
3. **POST请求**：点击按钮时发送POST请求到指定API，替换SKU参数
4. **数据处理**：接收返回数据后按`average_age`降序排序
5. **弹窗展示**：格式化展示仓库名称、库存总量、平均库龄信息
6. **错误处理**：包含网络错误、权限错误、无数据等情况的提示
7. **防重复添加**：避免重复添加按钮
8. **动态监听**：可选启用DOM变化监听，适配动态加载的页面

### 使用方式：
1. 将代码复制到浏览器控制台执行
2. 或集成到油猴脚本/页面脚本中
3. 点击页面上的"查看库存"按钮即可查询对应SKU的库存信息

### 注意事项：
- 确保页面已加载完成后执行
- 请求头中的部分参数（如`x-ak-request-id`）可能需要根据实际情况调整
- 如果页面有动态加载内容，可以启用底部的MutationObserver监听



















```javascript

// 获取所有含rowid属性的tr标签
const trList = document.querySelectorAll('tr[rowid]');

trList.forEach(tr => {
    // 查找内容含SKU的span
    const skuSpans = tr.querySelectorAll('span');
    let targetSpan = null;
    
    for (const span of skuSpans) {
        if (span.textContent.includes('SKU')) {
            const nextSpan = span.nextElementSibling;
            if (nextSpan && nextSpan.tagName === 'SPAN') {
                targetSpan = nextSpan.querySelector('div > span');
            }
            break;
        }
    }
    
    if (targetSpan) {
        const spanValue = targetSpan.textContent.trim();
        console.log('SKU对应的值:', spanValue);
        
        // 找到上一个tr的.left元素，添加按钮
        const prevTr = tr.previousElementSibling;
        if (prevTr) {
            const leftElement = prevTr.querySelector('.left');
            if (leftElement) {
                const button = document.createElement('button');
                button.textContent = '查看库存';
                button.style.marginLeft = '8px';
                button.style.padding = '4px 8px';
                
                // 绑定点击事件，提示SKU值
                button.addEventListener('click', function() {
                    alert(`SKU值：${spanValue}`);
                });
                
                leftElement.appendChild(button); // 添加到.left内部
            }
        }
    }
});
```