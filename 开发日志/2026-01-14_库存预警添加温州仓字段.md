# 库存预警添加温州仓字段开发日志

## 日期
2026-01-14

## 开发内容
为库存预警功能添加温州仓字段支持，将库存数据按温州仓和非温州仓进行分类显示和导出。

## 修改文件

### 1. 模型文件 - InventoryDetails.php
- 重构了`getInventoryAlert()`方法
- 更改了SQL查询逻辑，获取所有仓库数据
- 使用CASE语句分别统计温州仓（wid=5693）和非温州仓的数据
- 新增字段：
  - `product_valid_num_excluding_wenzhou`：可用量（不含温州仓）
  - `product_onway_excluding_wenzhou`：调拨在途（不含温州仓）
  - `product_valid_num_wenzhou`：可用量（温州仓）
  - `product_onway_wenzhou`：调拨在途（温州仓）

### 2. 视图文件 - inventory_alert.php
- 更新了表格表头，添加了温州仓相关字段
- 修改了数据单元格，使用新的字段名显示数据
- 更新了页面顶部的库存汇总卡片：
  - 将"总可用量"拆分为"总可用量（不含温州仓）"和"总可用量（温州仓）"
  - 将"总调拨在途"拆分为"总调拨在途（不含温州仓）"和"总调拨在途（温州仓）"

### 3. 控制器文件 - InventoryDetailsController.php
- 更新了`exportInventoryAlert()`方法，添加了温州仓字段
- 更新了CSV头部和数据行，确保导出文件包含所有新增字段

## 功能特性

1. **数据分类**：将库存数据明确分为温州仓和非温州仓两部分
2. **表格显示**：在表格中分别显示四个新增字段的数据
3. **库存汇总**：页面顶部的卡片显示各类别的总量
4. **导出功能**：导出的CSV文件包含所有新增字段
5. **数据过滤**：过滤条件保持一致，确保数据准确性
6. **视觉区分**：使用相同的颜色编码系统区分库存状态

## 技术实现

- 使用SQL的CASE语句实现数据分类统计
- 使用array_column()函数计算汇总数据
- 保持了原有的数据过滤和排序逻辑
- 确保了页面布局的响应式设计

## 测试建议

1. 访问库存预警页面：`http://localhost:8080/inventory_details.php?action=inventory_alert`
2. 检查表格：
   - 是否显示了所有四个新增字段
   - 数据是否正确分类
   - 颜色编码是否正常工作
3. 检查库存汇总卡片：
   - 卡片数量是否正确（6个）
   - 数据是否与表格数据一致
4. 测试导出功能：
   - 点击"导出数据"按钮
   - 检查CSV文件是否包含所有新增字段
   - 数据是否正确分类

## 后续优化方向

1. 添加温州仓数据的颜色编码
2. 支持按仓库类型筛选数据
3. 添加温州仓与非温州仓数据的对比图表
4. 优化大数据量下的页面加载性能