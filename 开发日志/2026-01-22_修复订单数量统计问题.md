# 2026-01-22 修复订单数量统计问题

## 问题描述

- **问题**：dashboard.php页面中显示的赛道统计总订单数量比实际少很多，但总订单金额是正确的
- **原因**：SQL查询中使用了`COUNT(DISTINCT op.id)`来计算订单数量，导致如果order_profit表中多条记录对应同一个订单（比如同一个订单的不同商品），这些记录会被合并为一个订单计数，而总订单金额使用`SUM`函数计算所有记录的金额，导致金额正确但数量少

## 修复方案

### 1. 模型层更新 (TrackStatistics.php)

- **修改SQL查询**：
  - 在`getTrackStatistics`方法中的orderSql查询中，将`COUNT(DISTINCT op.id)`修改为`COUNT(*)`
  - 原代码：`COUNT(DISTINCT op.id) as order_count,`
  - 修改后：`COUNT(*) as order_count,`

### 2. 技术要点

- **数据一致性**：确保订单数量和金额的计算基础一致，都基于order_profit表中的所有记录
- **SQL优化**：保持查询的简洁性和效率
- **业务逻辑**：根据实际业务需求，订单数量应该基于order_profit表中的记录数，而不是去重后的订单ID数
- **用户体验**：确保订单数量统计与金额统计保持一致，提高数据的可信度

### 3. 影响范围

- **dashboard.php**：赛道统计模块中的订单数量现在会与总订单金额的计算基础一致，基于order_profit表中的所有记录
- **数据准确性**：订单数量统计现在更加准确，与金额统计保持一致
- **用户体验**：订单数量和金额的统计现在基于相同的记录集，提高了数据的可信度

## 测试建议

1. **功能测试**：
   - 验证dashboard.php页面中的订单数量统计是否与预期一致
   - 确认总订单金额仍然正确
   - 验证订单数量和金额的统计是否基于相同的记录集

2. **数据验证**：
   - 手动计算order_profit表中的记录数，与dashboard.php页面显示的订单数量进行对比
   - 验证总订单金额是否与order_profit表中所有记录的金额总和一致

3. **边界测试**：
   - 测试order_profit表中只有一条记录的情况
   - 测试order_profit表中有多条记录的情况
   - 测试order_profit表中有重复订单ID的情况

## 总结

本次修复通过将`COUNT(DISTINCT op.id)`修改为`COUNT(*)`，确保了订单数量和金额的计算基础一致，都基于order_profit表中的所有记录。这样就解决了总订单金额正确但总订单数量少很多的问题，提高了数据的一致性和可信度。