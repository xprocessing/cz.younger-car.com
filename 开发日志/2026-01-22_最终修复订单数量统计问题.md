# 2026-01-22 最终修复订单数量统计问题

## 问题描述

- **问题**：dashboard.php页面中显示的赛道统计总订单数量比实际少很多，而总订单金额是正确的
- **原因**：多个因素导致订单数量统计不准确，包括NULL值处理、GROUP BY子句、日期过滤和数据匹配逻辑

## 修复方案

### 1. 模型层更新 (TrackStatistics.php)

#### 1.1 修改订单数量计算方式
- **原代码**：`COUNT(DISTINCT op.id) as order_count,`
- **修改后**：`COUNT(*) as order_count,`
- **原因**：确保订单数量基于所有记录计算，与金额计算基础一致

#### 1.2 修复NULL值分组问题
- **原代码**：`GROUP BY s.track_name`
- **修改后**：`GROUP BY COALESCE(s.track_name, '未分类赛道')`
- **原因**：确保NULL值的track_name也能正确分组，避免这些记录被遗漏

#### 1.3 优化日期过滤逻辑
- **原代码**：`DATE(op.global_purchase_time) BETWEEN ? AND ?`
- **修改后**：`op.global_purchase_time BETWEEN ? AND ?`
- **原因**：避免日期格式问题导致记录被过滤，确保所有订单都能被正确匹配

#### 1.4 改进数据匹配逻辑
- **原代码**：`return $item['track_name'] === $trackName;`
- **修改后**：`return $item['track_name'] == $trackName;`
- **原因**：使用宽松比较，确保类型不同的记录也能被正确匹配

### 2. 技术要点

- **数据一致性**：确保订单数量和金额的计算基础一致，都基于order_profit表中的所有记录
- **NULL值处理**：使用COALESCE函数处理NULL值，确保所有记录都能正确分组
- **日期过滤**：使用直接比较代替DATE函数，避免日期格式问题导致记录被过滤
- **数据匹配**：使用宽松比较，确保类型不同的记录也能被正确匹配
- **用户体验**：确保订单数量统计与金额统计保持一致，提高数据的可信度

### 3. 影响范围

- **dashboard.php**：赛道统计模块中的订单数量现在会基于所有记录计算，与金额统计保持一致
- **数据准确性**：订单数量统计现在更加准确，不会遗漏任何记录
- **用户体验**：订单数量和金额的统计现在基于相同的记录集，提高了数据的可信度

## 测试建议

1. **功能测试**：
   - 验证dashboard.php页面中的订单数量统计是否与预期一致
   - 确认总订单金额仍然正确
   - 验证订单数量和金额的统计是否基于相同的记录集

2. **边界测试**：
   - 测试order_profit表中只有一条记录的情况
   - 测试order_profit表中有多条记录的情况
   - 测试order_profit表中有重复订单ID的情况
   - 测试order_profit表中有NULL值track_name的情况

3. **数据验证**：
   - 手动计算order_profit表中的记录数，与dashboard.php页面显示的订单数量进行对比
   - 验证总订单金额是否与order_profit表中所有记录的金额总和一致
   - 验证'未分类赛道'的统计数据是否正确（如果存在NULL值track_name的记录）

## 总结

本次修复通过以下几个步骤解决了订单数量统计不准确的问题：

1. **修改计数方式**：将`COUNT(DISTINCT op.id)`改为`COUNT(*)`，确保订单数量基于所有记录计算
2. **修复分组问题**：将`GROUP BY s.track_name`改为`GROUP BY COALESCE(s.track_name, '未分类赛道')`，确保NULL值也能正确分组
3. **优化日期过滤**：将`DATE(op.global_purchase_time)`改为直接比较，避免日期格式问题导致记录被过滤
4. **改进数据匹配**：将严格比较`===`改为宽松比较`==`，确保类型不同的记录也能被正确匹配

这些修改确保了订单数量和金额的计算基础一致，都基于order_profit表中的所有记录，从而解决了总订单金额正确但总订单数量少很多的问题。