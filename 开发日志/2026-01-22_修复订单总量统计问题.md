# 2026-01-22 修复订单总量统计问题

## 问题描述

- **问题**：dashboard.php页面中显示的赛道统计订单总量比实际少很多
- **原因**：当order_profit表中的记录在store表中没有对应记录时，s.track_name会是NULL，然后在后续的array_filter中被过滤掉，导致这些订单被完全排除在统计之外

## 修复方案

### 1. 模型层更新 (TrackStatistics.php)

- **修改SQL查询**：
  - 在`getTrackStatistics`方法中的orderSql查询中，使用COALESCE函数为NULL的track_name提供一个默认值
  - 原代码：`s.track_name`
  - 修改后：`COALESCE(s.track_name, '未分类赛道') as track_name`

- **具体更改**：
  - 更新了订单数据查询的SELECT子句
  - 使用COALESCE函数处理NULL值，确保所有订单都能被统计
  - 为NULL的track_name设置默认值'未分类赛道'

### 2. 技术要点

- **NULL值处理**：使用COALESCE函数处理NULL值，确保数据完整性
- **SQL优化**：保持查询的简洁性和效率
- **数据一致性**：确保所有订单都能被统计，不管是否有对应的store记录
- **用户体验**：为未分类的赛道提供一个明确的标识，提高数据可读性

### 3. 影响范围

- **dashboard.php**：赛道统计模块中的订单总量现在会包含所有订单，无论是否有对应的store记录
- **数据准确性**：订单总量统计现在更加准确，不会遗漏任何订单
- **用户体验**：未分类的赛道会显示为'未分类赛道'，提高了数据的可读性

## 测试建议

1. **功能测试**：
   - 验证dashboard.php页面中的订单总量统计是否与实际订单数量一致
   - 检查是否有'未分类赛道'的统计数据（如果存在没有对应store记录的订单）
   - 验证其他统计数据（总订单金额、总毛利润等）是否也相应更新

2. **边界测试**：
   - 测试所有订单都有对应store记录的情况
   - 测试部分订单没有对应store记录的情况
   - 测试所有订单都没有对应store记录的情况

3. **数据验证**：
   - 手动计算订单总量，与dashboard.php页面显示的数量进行对比
   - 验证'未分类赛道'的统计数据是否正确

## 总结

本次修复通过使用COALESCE函数处理NULL值，确保了所有订单都能被统计，解决了订单总量比实际少很多的问题。同时，为未分类的赛道提供了一个明确的标识，提高了数据的可读性。此修复对系统的其他部分没有影响，是一个安全、有效的解决方案。