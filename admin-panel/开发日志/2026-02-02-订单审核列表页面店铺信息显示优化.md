# 2026-02-02 订单审核列表页面店铺信息显示优化

## 需求描述

在订单审核列表页面中，将"店铺ID"列改为显示"平台名字+店铺名字"，通过店铺的 `store_id` 关联 `store` 数据表中的 `platform_name` 和 `store_name` 字段，提升数据的可读性和用户体验。

## 数据表结构

### order_review 表
```sql
CREATE TABLE IF NOT EXISTS `order_review` (
    `id` INTEGER NOT NULL AUTO_INCREMENT UNIQUE,
    `store_id` CHAR(50) COMMENT '店铺id',
    `global_order_no` CHAR(50) NOT NULL COMMENT '订单号',
    ...
    PRIMARY KEY(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单审核';
```

### store 表
```sql
CREATE TABLE `store` (
  `store_id` varchar(64) NOT NULL COMMENT '店铺ID',
  `sid` varchar(50) DEFAULT NULL COMMENT '店铺编号',
  `store_name` varchar(100) NOT NULL COMMENT '店铺名称',
  `platform_code` varchar(20) NOT NULL COMMENT '平台编码',
  `platform_name` varchar(50) NOT NULL COMMENT '平台名称',
  ...
  PRIMARY KEY (`store_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='店铺信息表';
```

## 实现方案

### 1. 修改 OrderReview 模型

#### 修改 `getAll()` 方法
添加 LEFT JOIN 关联查询，获取店铺的平台名称和店铺名称：

```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id 
            ORDER BY orr.id DESC";
    $params = [];
    
    if ($limit !== null) {
        $sql .= " LIMIT ? OFFSET ?";
        $params[] = $limit;
        $params[] = $offset;
    }
    
    $stmt = $this->db->query($sql, $params);
    return $stmt->fetchAll();
}
```

**关键点：**
- 使用 `LEFT JOIN` 确保即使没有匹配的店铺记录，订单记录也会返回
- 使用表别名 `orr` 和 `s` 简化SQL语句
- 同时查询 `platform_name` 和 `store_name` 字段

#### 修改 `searchWithFilters()` 方法
在搜索查询中也添加店铺信息关联，并支持按平台名称和店铺名称搜索：

```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id 
            WHERE 1=1";
    $params = [];
    
    if (!empty($keyword)) {
        $sql .= " AND (orr.global_order_no LIKE ? OR orr.local_sku LIKE ? OR orr.receiver_country_code LIKE ? OR s.platform_name LIKE ? OR s.store_name LIKE ?)";
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
    }
    
    if (!empty($reviewStatus)) {
        $sql .= " AND orr.review_status = ?";
        $params[] = $reviewStatus;
    }
    
    if (!empty($startDate)) {
        $sql .= " AND orr.review_time >= ?";
        $params[] = $startDate;
    }
    
    if (!empty($endDate)) {
        $sql .= " AND orr.review_time <= ?";
        $params[] = $endDate;
    }
    
    $sql .= " ORDER BY orr.id DESC";
    
    if ($limit !== null) {
        $sql .= " LIMIT ? OFFSET ?";
        $params[] = $limit;
        $params[] = $offset;
    }
    
    $stmt = $this->db->query($sql, $params);
    return $stmt->fetchAll();
}
```

**关键点：**
- 在关键词搜索中添加 `s.platform_name` 和 `s.store_name` 的搜索
- 所有字段引用都添加表别名前缀，避免字段名冲突

### 2. 修改 index.php 视图

#### 修改表头
将"店铺ID"改为"店铺"：

```php
<th>店铺</th>
```

#### 修改数据显示
显示平台名称和店铺名称的组合，并提供降级处理：

```php
<td>
    <?php 
    $platform_name = $review['platform_name'] ?? '';
    $store_name = $review['store_name'] ?? '';
    if ($platform_name && $store_name) {
        echo htmlspecialchars($platform_name . ' - ' . $store_name);
    } elseif ($store_name) {
        echo htmlspecialchars($store_name);
    } else {
        echo htmlspecialchars($review['store_id'] ?? '');
    }
    ?>
</td>
```

**显示逻辑：**
1. 如果平台名称和店铺名称都存在，显示"平台名称 - 店铺名称"
2. 如果只有店铺名称，只显示店铺名称
3. 如果都没有，显示店铺ID作为降级方案

## 显示效果

### 修改前
```
| ID | 店铺ID      | 订单号          | ...
|----|-------------|-----------------|----
| 1  | STORE001    | ORD20260202001  | ...
| 2  | STORE002    | ORD20260202002  | ...
```

### 修改后
```
| ID | 店铺                    | 订单号          | ...
|----|-------------------------|-----------------|----
| 1  | Amazon - 美国旗舰店      | ORD20260202001  | ...
| 2  | eBay - 英国专营店        | ORD20260202002  | ...
```

## 修改内容

### OrderReview.php 模型

**第25-35行：修改 `getAll()` 方法**
```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id 
            ORDER BY orr.id DESC";
    // ...
}
```

**第104-145行：修改 `searchWithFilters()` 方法**
```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id 
            WHERE 1=1";
    // ...
}
```

### index.php 视图

**第120行：修改表头**
```php
<th>店铺</th>
```

**第143-155行：修改数据显示**
```php
<td>
    <?php 
    $platform_name = $review['platform_name'] ?? '';
    $store_name = $review['store_name'] ?? '';
    if ($platform_name && $store_name) {
        echo htmlspecialchars($platform_name . ' - ' . $store_name);
    } elseif ($store_name) {
        echo htmlspecialchars($store_name);
    } else {
        echo htmlspecialchars($review['store_id'] ?? '');
    }
    ?>
</td>
```

## 技术特点

1. **LEFT JOIN**：确保即使没有匹配的店铺记录，订单记录也会返回
2. **降级处理**：当店铺信息不存在时，显示店铺ID作为备选方案
3. **搜索增强**：支持按平台名称和店铺名称进行关键词搜索
4. **数据安全**：使用 `htmlspecialchars()` 防止XSS攻击
5. **表别名**：使用表别名简化SQL语句，避免字段名冲突

## 用户体验提升

1. **可读性**：显示平台名称和店铺名称，比店铺ID更直观
2. **搜索便利**：可以通过平台名称或店铺名称快速搜索订单
3. **容错性**：即使店铺信息缺失，也能正常显示店铺ID
4. **一致性**：所有查询方法都包含店铺信息，确保数据一致性

## 影响文件

- `admin-panel/models/OrderReview.php`
- `admin-panel/views/order_review/index.php`

## 测试建议

测试以下场景：
1. 有完整店铺信息的订单（显示"平台名称 - 店铺名称"）
2. 只有店铺名称的订单（只显示店铺名称）
3. 没有店铺信息的订单（显示店铺ID）
4. 按平台名称搜索订单
5. 按店铺名称搜索订单
6. 分页查询的店铺信息显示
7. 筛选条件下的店铺信息显示
