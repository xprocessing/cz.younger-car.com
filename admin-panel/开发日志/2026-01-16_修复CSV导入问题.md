# 开发日志：修复CSV导入问题

## 问题描述
用户上传CSV文件时遇到"没有有效数据可导入"错误，导致无法正常导入数据。

## 原因分析
经过代码分析，发现可能存在以下几个问题：

1. **表单字段名不匹配**：控制器中使用了`$_FILES['csv_file']`，但视图文件中表单字段名是`excel_file`
2. **UTF-8 BOM处理问题**：某些CSV文件可能包含UTF-8 BOM标记，导致fgetcsv函数无法正确解析
3. **空行问题**：CSV文件中可能包含空行，导致处理错误
4. **缺乏调试信息**：无法获取详细的错误信息，难以定位具体问题

## 修复内容

1. **修复表单字段名不匹配**：
   将控制器中`importPost`方法的表单字段名从`'csv_file'`改为`'excel_file'`

2. **添加UTF-8 BOM处理**：
   ```php
   // 处理UTF-8 BOM
   $bom = fread($handle, 3);
   if ($bom !== chr(0xEF) . chr(0xBB) . chr(0xBF)) {
       // 没有BOM，重新定位到文件开头
       fseek($handle, 0);
   }
   ```

3. **添加空行跳过逻辑**：
   ```php
   // 读取数据行
   while (($row = fgetcsv($handle)) !== false && $rowCount < 1000) {
       // 跳过空行
       if (empty($row) || (count($row) === 1 && empty($row[0]))) {
           continue;
       }
       
       $rowCount++;
       $this->processImportRow($row, $data, $rowCount, $successCount, $errorCount, $errors);
   }
   ```

4. **添加详细的调试信息**：
   ```php
   if (empty($data)) {
       // 记录调试信息
       $debugInfo = [
           'rowCount' => $rowCount,
           'errorCount' => $errorCount,
           'errors' => $errors
       ];
       $_SESSION['import_debug'] = $debugInfo;
       
       if (!empty($errors)) {
           showError('没有有效数据可导入，错误信息：' . implode('<br>', $errors));
       } else {
           showError('没有有效数据可导入，共处理了 ' . $rowCount . ' 行，但没有通过验证的数据。请检查CSV格式是否正确。');
       }
       redirect(ADMIN_PANEL_URL . '/shop_costs.php?action=import');
   }
   ```

## 验证
修复后，文件上传导入功能应该能够正常工作：
1. 点击"选择文件"按钮，选择CSV文件
2. 点击"开始导入"按钮
3. 系统能够正确处理UTF-8 BOM编码的CSV文件
4. 系统能够跳过空行
5. 系统能够提供详细的错误信息，帮助用户定位问题

## 注意事项
- 确保CSV文件格式符合要求：
  - 文件编码：UTF-8（带或不带BOM均可）
  - 字段分隔符：逗号（,）
  - 字段顺序：平台名称、店铺名称、日店铺花费、费用类型、费用日期、备注（可选）
  - 日期格式：YYYY-MM-DD
  - 金额格式：数字（如299.50）

- 同一平台、店铺、日期的记录将被视为重复，导入时会跳过

修复时间：2026-01-16 14:00:00
修复人员：开发人员