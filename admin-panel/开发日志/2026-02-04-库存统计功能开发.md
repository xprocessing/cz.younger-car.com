# 库存统计功能开发

## 日期
2026-02-04

## 更新内容

### 1. 创建库存统计视图文件
- 文件路径: `admin-panel/views/inventory_details/inventory_stats.php`
- 功能: 显示仓库库存统计页面
- 统计卡片:
  - 仓库总数
  - 总可用库存
  - 总调拨在途
  - 总待到货
- 统计表格:
  - 仓库ID
  - 仓库名称
  - 可用数量
  - 调拨在途数量
  - 待到货数量
  - 总数量

### 2. 添加控制器方法
- 文件: `admin-panel/controllers/InventoryDetailsController.php`
- 方法名: `inventoryStats()`
- 功能: 处理库存统计页面请求
- 权限验证: 需要inventory_details.view权限
- 数据获取: 调用模型的getInventoryByWarehouse()方法

### 3. 添加模型方法
- 文件: `admin-panel/models/InventoryDetails.php`
- 方法名: `getInventoryByWarehouse()`
- SQL查询:
  ```sql
  SELECT i.wid, w.name as warehouse_name,
         SUM(i.product_valid_num) as total_valid,
         SUM(i.product_onway) as total_onway,
         SUM(CAST(i.quantity_receive AS UNSIGNED)) as total_receive
  FROM inventory_details i
  LEFT JOIN warehouses w ON i.wid = w.wid
  GROUP BY i.wid, w.name
  ORDER BY w.name
  ```
- 功能: 按仓库分组统计库存数据
- 统计字段:
  - product_valid_num: 可用库存数量
  - product_onway: 调拨在途数量
  - quantity_receive: 待到货数量

### 4. 添加页面按钮
- 文件: `admin-panel/views/inventory_details/index.php`
- 按钮位置: 库存预警和库龄统计按钮之间
- 按钮样式: 绿色按钮，带图表图标
- 按钮链接: `inventory_details.php?action=inventory_stats`

### 5. 添加路由
- 文件: `admin-panel/inventory_details.php`
- 路由: `inventory_stats`
- 处理方法: `$inventoryDetailsController->inventoryStats()`

## 技术实现

### 数据库表结构
- inventory_details表: 存储库存明细数据
- warehouses表: 存储仓库信息
- 关联字段: inventory_details.wid = warehouses.wid

### 统计逻辑
- 按仓库ID分组
- 使用SUM函数聚合各字段
- 使用LEFT JOIN确保所有仓库都被包含
- 按仓库名称排序

### 权限控制
- 使用hasPermission('inventory_details.view')验证权限
- 无权限时显示错误信息并跳转到仪表板

## 使用说明

1. 访问库存明细页面
2. 点击"库存统计"按钮
3. 查看各仓库的库存统计信息
4. 可点击"返回列表"返回库存明细页面

## 注意事项

- quantity_receive字段需要转换为UNSIGNED类型进行SUM运算
- 使用LEFT JOIN确保即使没有库存数据的仓库也会显示
- 统计数据实时计算，不使用缓存
