# 2026-01-12 完善ding_v2.php库存预警功能

## 更新内容

完善了 `admin-panel/ding_v2.php` 文件中的库存预警功能，实现了三个关键查询：

### 1. 昨日亏损超过10美元的订单查询
- **功能**：从 `order_profit` 表中获取昨日亏损超过10美元的订单
- **实现**：使用 `DATE(STR_TO_DATE())` 转换日期格式，确保正确匹配昨天的订单
- **字段**：订单号、亏损金额、SKU、下单时间

### 2. 库龄超过180天的SKU查询
- **功能**：从 `inventory_details` 表中获取库龄超过180天的SKU
- **实现**：使用 `average_age` 字段筛选超过180天的库存
- **字段**：SKU、平均库龄(天)、可用库存

### 3. 近30天有销量但库存不足的SKU查询
- **功能**：关联 `order_profit` 和 `inventory_details` 表，查询近30天有销量但库存不足的SKU
- **实现**：
  - 计算近30天的销量和销售额
  - 判断可用库存是否不足
  - 使用 `CAST(REPLACE())` 转换金额字符串为数值类型
- **字段**：SKU、销量、总销售额、可用库存

## 技术实现要点

1. **数据库连接**：使用PDO连接数据库，确保安全的SQL执行
2. **参数化查询**：防止SQL注入攻击
3. **日期处理**：使用 `DATE()`、`STR_TO_DATE()` 和 `strtotime()` 确保正确的日期处理
4. **数据格式化**：将查询结果格式化为Markdown表格，便于钉钉消息展示
5. **错误处理**：使用PDO异常模式处理数据库错误

## 文件更新

- **更新文件**：`admin-panel/ding_v2.php`
- **更新范围**：第192-283行
- **核心功能**：实现了三个库存相关的预警查询，为钉钉消息推送提供数据支持