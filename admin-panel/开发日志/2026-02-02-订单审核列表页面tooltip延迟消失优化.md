# 2026-02-02 订单审核列表页面tooltip延迟消失优化

## 需求描述

在订单审核列表页面中，tooltip弹窗消失得太快，用户在查看运费列表时，tooltip会立即消失，影响用户体验。需要优化tooltip的消失逻辑，添加延迟消失功能，让用户有足够的时间查看完整信息。

## 问题分析

### 原始实现问题

原始代码在鼠标离开元素时立即移除tooltip：

```javascript
element.addEventListener('mouseleave', function() {
    if (this._tooltip) {
        document.body.removeChild(this._tooltip);
        this._tooltip = null;
    }
});
```

**存在的问题：**
1. **消失太快**：鼠标一离开元素，tooltip立即消失
2. **阅读困难**：用户没有足够时间查看完整的运费列表
3. **操作不便**：用户需要精确控制鼠标位置才能保持tooltip显示

## 优化方案

### 1. 添加延迟消失功能

使用 `setTimeout` 延迟移除tooltip，给用户300ms的缓冲时间：

```javascript
element.addEventListener('mouseleave', function() {
    hideTimeout = setTimeout(function() {
        if (tooltip && tooltip.parentNode) {
            document.body.removeChild(tooltip);
            tooltip = null;
        }
    }, 300);
});
```

**关键点：**
- 延迟300ms后移除tooltip
- 检查tooltip是否存在且在DOM中
- 使用局部变量 `tooltip` 替代 `this._tooltip`

### 2. 添加鼠标重新进入清除延迟

当鼠标重新进入元素时，清除延迟移除的定时器：

```javascript
element.addEventListener('mouseenter', function() {
    clearTimeout(hideTimeout);
});
```

**关键点：**
- 鼠标重新进入时清除定时器
- 防止tooltip被意外移除
- 保持tooltip的连续显示

### 3. 在鼠标进入时清除之前的定时器

在 `mouseenter` 事件开始时清除之前的定时器：

```javascript
element.addEventListener('mouseenter', function(e) {
    clearTimeout(hideTimeout);
    
    // ... 其他代码
});
```

**关键点：**
- 防止多次快速进出导致的定时器冲突
- 确保tooltip显示逻辑的稳定性

## 完整代码

```javascript
document.addEventListener('DOMContentLoaded', function() {
    const truncateTexts = document.querySelectorAll('.truncate-text');
    
    truncateTexts.forEach(function(element) {
        let tooltip = null;
        let hideTimeout = null;
        
        element.addEventListener('mouseenter', function(e) {
            clearTimeout(hideTimeout);
            
            const fullText = this.getAttribute('data-full');
            if (!fullText || fullText === '') return;
            
            tooltip = document.createElement('div');
            tooltip.className = 'tooltip-custom';
            
            try {
                const jsonData = JSON.parse(fullText);
                if (Array.isArray(jsonData)) {
                    let html = '<strong>运费列表：</strong><br>';
                    jsonData.forEach(function(item, index) {
                        html += `<br><strong>${index + 1}.</strong> `;
                        if (item.channel_code) {
                            html += `渠道: ${item.channel_code} | `;
                        }
                        if (item.currency && item.totalFee) {
                            html += `费用: ${item.currency} ${item.totalFee}`;
                        } else if (item.totalFee) {
                            html += `费用: ${item.totalFee}`;
                        }
                        if (item.currency === null || item.totalFee === null) {
                            html += ' (无报价)';
                        }
                    });
                    tooltip.innerHTML = html;
                } else {
                    tooltip.textContent = fullText;
                }
            } catch (e) {
                tooltip.textContent = fullText;
            }
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            
            let tooltipLeft = rect.left + scrollLeft;
            let tooltipTop = rect.bottom + scrollTop + 5;
            
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (tooltipLeft + tooltipRect.width > viewportWidth) {
                tooltipLeft = rect.right + scrollLeft - tooltipRect.width;
            }
            
            if (tooltipTop + tooltipRect.height > viewportHeight + scrollTop) {
                tooltipTop = rect.top + scrollTop - tooltipRect.height - 5;
            }
            
            tooltip.style.left = tooltipLeft + 'px';
            tooltip.style.top = tooltipTop + 'px';
            
            this._tooltip = tooltip;
        });
        
        element.addEventListener('mouseleave', function() {
            hideTimeout = setTimeout(function() {
                if (tooltip && tooltip.parentNode) {
                    document.body.removeChild(tooltip);
                    tooltip = null;
                }
            }, 300);
        });
        
        element.addEventListener('mouseenter', function() {
            clearTimeout(hideTimeout);
        });
    });
});
```

## 优化效果

### 场景1：鼠标快速进出
- tooltip不会立即消失
- 延迟300ms后消失
- 给用户缓冲时间

### 场景2：鼠标重新进入
- 清除延迟定时器
- tooltip继续显示
- 避免闪烁

### 场景3：查看完整信息
- 用户有足够时间查看运费列表
- 不需要精确控制鼠标位置
- 提升阅读体验

## 技术特点

1. **延迟消失**：使用 `setTimeout` 延迟300ms移除tooltip
2. **定时器管理**：使用 `clearTimeout` 清除定时器
3. **状态检查**：检查tooltip是否存在且在DOM中
4. **防抖处理**：防止多次快速进出导致的定时器冲突
5. **局部变量**：使用闭包变量管理tooltip状态

## 用户体验提升

1. **阅读时间**：用户有足够时间查看完整的运费列表
2. **操作便利**：不需要精确控制鼠标位置
3. **视觉稳定**：tooltip不会频繁闪烁
4. **容错性**：鼠标意外离开后还有缓冲时间

## 修改内容

### index.php 视图（第281-357行）

**修改前：**
```javascript
truncateTexts.forEach(function(element) {
    element.addEventListener('mouseenter', function(e) {
        const fullText = this.getAttribute('data-full');
        if (!fullText || fullText === '') return;
        
        let tooltip = document.createElement('div');
        tooltip.className = 'tooltip-custom';
        
        // ... 其他代码
        
        this._tooltip = tooltip;
    });
    
    element.addEventListener('mouseleave', function() {
        if (this._tooltip) {
            document.body.removeChild(this._tooltip);
            this._tooltip = null;
        }
    });
});
```

**修改后：**
```javascript
truncateTexts.forEach(function(element) {
    let tooltip = null;
    let hideTimeout = null;
    
    element.addEventListener('mouseenter', function(e) {
        clearTimeout(hideTimeout);
        
        const fullText = this.getAttribute('data-full');
        if (!fullText || fullText === '') return;
        
        tooltip = document.createElement('div');
        tooltip.className = 'tooltip-custom';
        
        // ... 其他代码
        
        this._tooltip = tooltip;
    });
    
    element.addEventListener('mouseleave', function() {
        hideTimeout = setTimeout(function() {
            if (tooltip && tooltip.parentNode) {
                document.body.removeChild(tooltip);
                tooltip = null;
            }
        }, 300);
    });
    
    element.addEventListener('mouseenter', function() {
        clearTimeout(hideTimeout);
    });
});
```

## 影响文件

- `admin-panel/views/order_review/index.php`

## 测试建议

测试以下场景：
1. 鼠标快速进出元素，tooltip是否延迟消失
2. 鼠标重新进入元素，tooltip是否继续显示
3. 查看完整的运费列表，是否有足够时间
4. 多个tooltip同时显示的情况
5. 页面滚动后的tooltip行为
