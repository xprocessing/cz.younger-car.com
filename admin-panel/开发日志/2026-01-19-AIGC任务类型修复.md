# AIGC任务类型修复日志

## 问题描述

在使用文生图功能时，系统报错：
```
Fatal error: Uncaught PDOException: SQLSTATE[01000]: Warning: 1265 Data truncated for column 'task_type' at row 1 in /www/wwwroot/cz.younger-car.com/admin-panel/includes/database.php:38
```

## 问题原因

1. 数据库中`aigc_tasks`表的`task_type`字段定义为ENUM类型，允许的值为：
   ```sql
   ENUM('remove_defect', 'crop_png', 'crop_white_bg', 'resize', 'watermark', 'face_swap', 'multi_angle', 'other')
   ```

2. 但在前端页面(`aigc/index.php`)中，支持了以下任务类型：
   - remove_defect（批量去瑕疵）
   - crop_png（批量抠图PNG）
   - crop_white_bg（批量抠图白底）
   - resize（批量改尺寸）
   - watermark（批量打水印）
   - face_swap（智能换脸）
   - image_to_image（图生图）
   - text_to_image（文生图）

3. 当用户选择"文生图"功能时，系统尝试将`text_to_image`值插入到`task_type`字段中，但由于该值不在ENUM允许的列表中，导致数据被截断，引发PDOException错误。

## 解决方案

1. 修改数据库表结构，将`image_to_image`和`text_to_image`添加到`task_type`字段的ENUM允许值列表中：

```sql
ALTER TABLE aigc_tasks MODIFY COLUMN task_type ENUM('remove_defect', 'crop_png', 'crop_white_bg', 'resize', 'watermark', 'face_swap', 'multi_angle', 'image_to_image', 'text_to_image', 'other') NOT NULL COMMENT '任务类型';
```

2. 创建了SQL更新文件：`database/update_task_type_enum.sql`

## 修复步骤

1. 分析错误日志，确定问题出在数据类型不匹配
2. 查看数据库表结构，确认`task_type`字段是ENUM类型
3. 检查前端页面支持的任务类型
4. 编写ALTER TABLE语句添加缺少的任务类型
5. 创建SQL更新文件便于部署

## 验证方法

1. 在MySQL中执行`database/update_task_type_enum.sql`文件
2. 重新使用文生图功能，确认不再报错
3. 检查任务是否成功保存到数据库中

## 文件修改记录

- 创建：`database/update_task_type_enum.sql` - 包含更新数据库表结构的SQL语句
- 创建：`开发日志/2026-01-19-AIGC任务类型修复.md` - 记录本次修复的详细信息
