# 2026-01-16 修复路径定义和日志目录权限问题

## 问题概述

修复了AIGC模块中出现的以下问题：

1. **视图文件路径错误**：
   ```
   Warning: include(/www/wwwroot/cz.younger-car.com/views/layouts/header.php): Failed to open stream: No such file or directory
   ```

2. **日志目录权限错误**：
   ```
   Warning: mkdir(): Permission denied in /www/wwwroot/cz.younger-car.com/admin-panel/includes/Logger.php on line 32
   ```

3. **APP_ROOT常量重复定义**（之前修复过但可能仍有影响）

## 修复内容

### 1. 修复视图和公共目录路径定义

**修改文件**：`admin-panel/config/config.php`

修正了VIEWS_DIR和PUBLIC_DIR的路径定义：

```php
// 原代码
define('PUBLIC_DIR', APP_ROOT . '/public');
define('VIEWS_DIR', APP_ROOT . '/views');

// 修复后的代码
define('PUBLIC_DIR', APP_ROOT . '/admin-panel/public');
define('VIEWS_DIR', APP_ROOT . '/admin-panel/views');
```

### 2. 修复日志目录路径和添加错误处理

**修改文件**：`admin-panel/includes/Logger.php`

- 修正了日志目录路径
- 添加了错误处理，在权限不足时自动切换到系统临时目录

```php
// 原代码
private function __construct() {
    // 初始化日志文件路径
    $log_dir = APP_ROOT . '/logs';
    if (!is_dir($log_dir)) {
        mkdir($log_dir, 0777, true);
    }
    
    $this->log_file = $log_dir . '/aigc_' . date('Y-m-d') . '.log';
    $this->log_level = self::LEVEL_INFO;
}

// 修复后的代码
private function __construct() {
    // 初始化日志文件路径
    $log_dir = APP_ROOT . '/admin-panel/logs';
    if (!is_dir($log_dir)) {
        // 尝试创建日志目录，如果失败则使用系统临时目录
        if (!@mkdir($log_dir, 0777, true)) {
            $log_dir = sys_get_temp_dir();
        }
    }
    
    $this->log_file = $log_dir . '/aigc_' . date('Y-m-d') . '.log';
    $this->log_level = self::LEVEL_INFO;
}
```

## 验证结果

修复后，AIGC模块能够：

1. 正确加载视图文件（header.php, index.php, footer.php）
2. 处理日志目录权限问题，避免因权限不足导致应用崩溃
3. 保持APP_ROOT常量的正确定义

系统现在可以正常显示AIGC模块的主页面，并处理图片生成任务。

## 影响范围

此修复影响整个AIGC模块的功能，包括：

- 页面显示
- 图片处理任务
- 日志记录

修复后，用户可以正常访问和使用AI图片处理功能。