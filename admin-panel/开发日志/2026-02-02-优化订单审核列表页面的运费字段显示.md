# 2026-02-02 优化订单审核列表页面的运费字段显示

## 需求描述

在订单审核列表页面中，`wd_yunfei`（运德运费）和 `ems_yunfei`（中邮运费）字段存储的是JSON格式的运费列表数据，包含多个物流渠道的报价信息。由于数据量大，直接显示会影响页面布局和可读性，需要优化显示方式。

## 数据格式

运费数据格式示例：
```json
[
  {"currency": "USD", "totalFee": "11.5420", "channel_code": "AMGD"},
  {"currency": "USD", "totalFee": "13.5230", "channel_code": "FDXSPE"},
  {"currency": "USD", "totalFee": "15.3941", "channel_code": "FEDHDE"},
  {"currency": null, "totalFee": null, "channel_code": "GFGNJ"},
  {"currency": "USD", "totalFee": "9.6400", "channel_code": "GFYUNNJ"}
]
```

## 实现方案

### 1. 字符截断显示

在表格单元格中只显示前5个字符，超出部分使用省略号：

```php
<td>
    <div class="truncate-text" 
         data-full="<?php echo htmlspecialchars($review['wd_yunfei'] ?? '', ENT_QUOTES); ?>"
         title="<?php echo htmlspecialchars($review['wd_yunfei'] ?? '', ENT_QUOTES); ?>">
        <?php echo mb_substr($review['wd_yunfei'] ?? '', 0, 5); ?>
    </div>
</td>
```

**关键点：**
- 使用 `mb_substr()` 函数截取前5个字符，支持多字节字符
- 使用 `data-full` 属性存储完整数据，供JavaScript使用
- 使用 `title` 属性提供浏览器原生的tooltip（作为备用）
- 使用 `htmlspecialchars()` 防止XSS攻击

### 2. CSS样式

添加自定义样式实现字符截断和tooltip效果：

```css
.truncate-text {
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    position: relative;
}

.truncate-text:hover {
    background-color: #f8f9fa;
}

.tooltip-custom {
    position: absolute;
    background: #333;
    color: #fff;
    padding: 10px;
    border-radius: 4px;
    font-size: 12px;
    max-width: 400px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    white-space: pre-wrap;
    word-wrap: break-word;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.tooltip-custom::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 10px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid #333;
}
```

**样式特点：**
- `truncate-text` 类实现文本截断，最大宽度80px
- 鼠标悬停时背景色变化，提示用户可交互
- `tooltip-custom` 类实现自定义tooltip，支持滚动
- 添加小箭头指向触发元素

### 3. JavaScript交互

添加鼠标悬停事件，解析JSON数据并以友好格式显示：

```javascript
document.addEventListener('DOMContentLoaded', function() {
    const truncateTexts = document.querySelectorAll('.truncate-text');
    
    truncateTexts.forEach(function(element) {
        element.addEventListener('mouseenter', function(e) {
            const fullText = this.getAttribute('data-full');
            if (!fullText || fullText === '') return;
            
            let tooltip = document.createElement('div');
            tooltip.className = 'tooltip-custom';
            
            try {
                const jsonData = JSON.parse(fullText);
                if (Array.isArray(jsonData)) {
                    let html = '<strong>运费列表：</strong><br>';
                    jsonData.forEach(function(item, index) {
                        html += `<br><strong>${index + 1}.</strong> `;
                        if (item.channel_code) {
                            html += `渠道: ${item.channel_code} | `;
                        }
                        if (item.currency && item.totalFee) {
                            html += `费用: ${item.currency} ${item.totalFee}`;
                        } else if (item.totalFee) {
                            html += `费用: ${item.totalFee}`;
                        }
                        if (item.currency === null || item.totalFee === null) {
                            html += ' (无报价)';
                        }
                    });
                    tooltip.innerHTML = html;
                } else {
                    tooltip.textContent = fullText;
                }
            } catch (e) {
                tooltip.textContent = fullText;
            }
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 5) + 'px';
            
            this._tooltip = tooltip;
        });
        
        element.addEventListener('mouseleave', function() {
            if (this._tooltip) {
                document.body.removeChild(this._tooltip);
                this._tooltip = null;
            }
        });
    });
});
```

**功能特点：**
- 解析JSON数据，判断是否为数组
- 格式化显示运费信息：渠道编码、货币、费用
- 处理无报价情况（currency或totalFee为null）
- 错误处理：解析失败时显示原始文本
- 鼠标离开时自动移除tooltip

## 显示效果

### 默认状态
- 表格单元格只显示前5个字符（如：`[{"c`）
- 超出部分显示省略号
- 鼠标悬停时背景色变为浅灰色

### 鼠标悬停状态
显示完整的运费列表，格式如下：

```
运费列表：

1. 渠道: AMGD | 费用: USD 11.5420
2. 渠道: FDXSPE | 费用: USD 13.5230
3. 渠道: FEDHDE | 费用: USD 15.3941
4. 渠道: GFGNJ | 费用: null (无报价)
5. 渠道: GFYUNNJ | 费用: USD 9.6400
```

## 影响文件

- `admin-panel/views/order_review/index.php`

## 修改内容

1. **第1-44行**：添加CSS样式
   - `.truncate-text` 类：实现文本截断
   - `.tooltip-custom` 类：自定义tooltip样式

2. **第106-120行**：修改wd_yunfei和ems_yunfei字段显示
   - 使用 `mb_substr()` 截取前5个字符
   - 添加 `data-full` 属性存储完整数据
   - 添加 `title` 属性作为备用tooltip

3. **第250-307行**：添加JavaScript交互代码
   - 监听鼠标悬停事件
   - 解析JSON数据并格式化显示
   - 动态创建和移除tooltip

## 用户体验提升

1. **页面整洁**：表格列宽保持合理，不会因为长JSON数据而变形
2. **信息完整**：鼠标悬停可查看完整的运费信息
3. **格式友好**：JSON数据以易读的列表格式展示
4. **交互流畅**：tooltip跟随鼠标位置，响应迅速
5. **容错处理**：解析失败时显示原始文本，不影响使用

## 测试建议

测试以下场景：
1. 有完整运费数据的订单
2. 运费数据为空的订单
3. 运费数据格式错误的订单
4. 鼠标快速滑过tooltip的响应
5. 长列表数据的滚动显示
6. 不同屏幕尺寸下的显示效果
