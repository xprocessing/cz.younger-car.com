# 库存明细功能更新

## 日期
2026-01-05

## 更新内容

### 1. 库存明细列表排序功能

#### 修改文件
- `models/InventoryDetails.php`
- `controllers/InventoryDetailsController.php`
- `views/inventory_details/index.php`

#### 功能说明
为库存明细列表的表头添加了点击排序功能，支持以下字段排序：
- ID
- 仓库ID
- SKU
- 可用量
- 待到货量
- 平均库龄(天)
- 采购单价
- 单位头程费用
- 单位库存成本

#### 实现细节
- 模型方法添加排序参数支持（sortField, sortOrder）
- 控制器处理排序参数传递
- 视图添加可点击排序表头，显示排序图标（升序/降序/未排序）
- 分页链接保持排序状态
- 添加"清除排序"按钮

### 2. 库龄统计功能

#### 修改文件
- `models/InventoryDetails.php` - 新增 `getOveragedInventory()` 方法
- `controllers/InventoryDetailsController.php` - 新增 `overagedStats()` 方法
- `views/inventory_details/overaged_stats.php` - 新建视图文件
- `inventory_details.php` - 添加路由
- `views/inventory_details/index.php` - 添加入口按钮

#### 功能说明
统计平均库龄超过180天的SKU及其库存和仓库名称。

#### 显示内容
- 统计卡片：SKU总数、总库存量、平均库龄、涉及仓库数
- 详细列表：序号、SKU、可用量、平均库龄、仓库ID、仓库名称
- 支持通过URL参数threshold自定义库龄阈值（默认180天）

### 3. 库存预警功能

#### 修改文件
- `models/InventoryDetails.php` - 新增 `getInventoryAlert()` 方法
- `controllers/InventoryDetailsController.php` - 新增 `inventoryAlert()` 方法
- `views/inventory_details/inventory_alert.php` - 新建视图文件
- `inventory_details.php` - 添加路由
- `views/inventory_details/index.php` - 添加入口按钮

#### 功能说明
统计SKU在所有仓库的库存情况，并根据30天出库量进行预警。

#### 显示内容
- 统计卡片：SKU总数、总可用量、30天总出库量、总待到货量
- 详细列表：序号、SKU、可用量、待到货量、调拨在途、30天出库量

#### 数据统计规则
- 30天出库量：根据order_profit表的local_sku + global_purchase_time统计（最近30天）
- SKU统计：按SKU汇总所有仓库的数据（排除wid=5693）
- 排序：按30天出库量从多到少排序

#### 预警规则
- 可用量预警：
  - 红色：库存不足30天（可用量/30天出库量*30 < 30）
  - 黄色：库存不足60天（可用量/30天出库量*30 < 60）
  - 绿色：库存充足

### 4. 修复问题

#### 修复内容
- 修复 `htmlspecialchars()` 函数接收null值的问题（inventory_alert.php第73行）
- 使用 `?? ''` 运算符提供默认值

## 技术要点

### 数据库查询
- 使用LEFT JOIN关联warehouses表获取仓库名称
- 使用子查询统计30天出库量
- 使用SUM()聚合函数按SKU汇总数据
- 使用COALESCE()处理NULL值

### 前端交互
- 表头点击切换排序（ASC/DESC）
- 排序图标显示当前状态
- 分页保持筛选和排序状态
- 颜色标记预警状态

### 权限控制
- 所有功能使用 `inventory_details.view` 权限
- 确保只有授权用户可以访问

## 后续优化建议

1. 添加库存预警阈值配置功能
2. 支持自定义预警规则
3. 添加数据导出功能
4. 优化大数据量查询性能
5. 添加库存预警通知功能
