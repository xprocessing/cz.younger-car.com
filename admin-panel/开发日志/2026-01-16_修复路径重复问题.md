# 2026-01-16 修复路径重复问题

## 问题概述

修复了AIGC模块中出现的路径重复问题，导致系统出现以下错误：

```
Warning: require_once(/www/wwwroot/cz.younger-car.com/admin-panel/admin-panel/models/User.php): Failed to open stream: No such file or directory
```

## 核心问题

路径重复的根本原因是APP_ROOT的定义与使用方式不一致：
- APP_ROOT被定义为网站根目录
- 但在代码中使用时又添加了/admin-panel前缀，导致路径重复

## 修复内容

### 1. 重新定义APP_ROOT

**修改文件**：`admin-panel/config/config.php`

将APP_ROOT定义为admin-panel目录：

```php
if (!defined('APP_ROOT')) {
    // APP_ROOT指向admin-panel目录
    define('APP_ROOT', dirname(__DIR__));
}
```

### 2. 更新目录路径定义

**修改文件**：`admin-panel/config/config.php`

更新PUBLIC_DIR和VIEWS_DIR的定义，使其与新的APP_ROOT一致：

```php
define('PUBLIC_DIR', APP_ROOT . '/public');
define('VIEWS_DIR', APP_ROOT . '/views');
```

### 3. 修复控制器路径

#### AuthController.php
- 更新User模型和helpers/functions.php的路径

#### AIGCController.php
- 更新AIGC模型、helpers/functions.php和Logger.php的路径

### 4. 修复模型文件路径

#### AIGC.php
- 更新配置文件、数据库文件和日志文件的路径

### 5. 修复辅助函数路径

#### helpers/functions.php
- 更新Permission和Role模型的路径

### 6. 修复日志系统路径

#### Logger.php
- 更新日志目录路径

### 7. 修复异步处理脚本路径

#### scripts/process_images_worker.php
- 更新APP_ROOT定义
- 更新包含文件的路径

## 修复结果

通过将APP_ROOT统一指向admin-panel目录，现在所有文件都使用一致的路径结构，不再出现路径重复的问题。修复后，系统可以正常处理：

- 仪表盘页面
- AI图片处理模块
- 权限检查功能
- 异步图片处理脚本

## 经验总结

1. **保持路径定义的一致性**：APP_ROOT的定义应与代码中的使用方式一致
2. **避免路径重复**：在使用APP_ROOT时，不需要再添加重复的目录前缀
3. **使用相对路径**：对于入口文件，使用__DIR__包含配置文件更加可靠
4. **全面测试**：修复后需要测试所有相关功能，确保没有引入新的问题