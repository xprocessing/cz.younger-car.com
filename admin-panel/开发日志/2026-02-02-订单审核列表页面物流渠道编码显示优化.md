# 2026-02-02 订单审核列表页面物流渠道编码显示优化

## 需求描述

在订单审核列表页面中，将"物流方式ID（已设置）"列改为显示"物流渠道编码"，通过物流的 `logistics_type_id` 关联 `logistics` 数据表中的 `type_id` 对应的 `code` 字段，提升数据的可读性和用户体验。

## 数据表结构

### order_review 表
```sql
CREATE TABLE IF NOT EXISTS `order_review` (
    `id` INTEGER NOT NULL AUTO_INCREMENT UNIQUE,
    `store_id` CHAR(50) COMMENT '店铺id',
    `wid` INT DEFAULT NULL COMMENT '仓库wid',
    `logistics_type_id` VARCHAR(64) DEFAULT NULL COMMENT '物流方式id',
    ...
    PRIMARY KEY(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单审核';
```

### logistics 表
```sql
CREATE TABLE IF NOT EXISTS logistics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '自增主键',
    type_id VARCHAR(64) NOT NULL COMMENT '物流类型ID',
    is_used TINYINT NOT NULL COMMENT '是否启用 1-启用 0-禁用',
    name VARCHAR(128) NOT NULL COMMENT '物流渠道名称',
    code VARCHAR(64) NOT NULL COMMENT '物流渠道编码',
    logistics_provider_id VARCHAR(64) NOT NULL COMMENT '物流服务商ID',
    order_type TINYINT NOT NULL COMMENT '订单类型',
    channel_type TINYINT NOT NULL COMMENT '渠道类型',
    relate_olt_id VARCHAR(64) NOT NULL DEFAULT '0' COMMENT '关联OLT ID',
    fee_template_id BIGINT NOT NULL DEFAULT 0 COMMENT '费用模板ID',
    billing_type TINYINT NOT NULL DEFAULT 0 COMMENT '计费类型',
    volume_param INT NOT NULL COMMENT '体积参数',
    warehouse_type TINYINT NOT NULL COMMENT '仓库类型',
    logistics_provider_name VARCHAR(128) NOT NULL COMMENT '物流服务商名称',
    provider_is_used TINYINT NOT NULL COMMENT '服务商是否启用 1-启用 0-禁用',
    is_platform_provider TINYINT NOT NULL COMMENT '是否平台服务商 1-是 0-否',
    supplier_code VARCHAR(64) NOT NULL COMMENT '供应商编码',
    wp_code VARCHAR(64) NOT NULL COMMENT '仓库编码',
    type TINYINT NOT NULL COMMENT '物流类型',
    wid INT NOT NULL COMMENT '仓库ID',
    is_combine_channel BOOLEAN NOT NULL COMMENT '是否组合渠道',
    tms_provider_id BIGINT NOT NULL DEFAULT 0 COMMENT 'TMS服务商ID',
    tms_provider_type TINYINT NOT NULL DEFAULT 0 COMMENT 'TMS服务商类型',
    supplier_id BIGINT NOT NULL DEFAULT 0 COMMENT '供应商ID',
    is_support_domestic_provider BOOLEAN NOT NULL COMMENT '是否支持国内服务商',
    is_need_marking BOOLEAN NOT NULL COMMENT '是否需要标记',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_type_id (type_id),
    INDEX idx_code (code),
    INDEX idx_logistics_provider_id (logistics_provider_id),
    INDEX idx_wid (wid),
    INDEX idx_is_used (is_used)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物流渠道';
```

## 排序规则冲突问题及解决方案

### 问题描述
在实现物流渠道编码显示功能后，遇到了以下错误：

```
Fatal error: Uncaught PDOException: SQLSTATE[HY000]: General error: 1267 Illegal mix of collations (utf8mb4_unicode_ci,IMPLICIT) and (utf8mb4_general_ci,IMPLICIT) for operation '='
```

### 原因分析
- `order_review` 表使用 `utf8mb4_unicode_ci` 排序规则
- `logistics` 表使用 `utf8mb4_general_ci` 排序规则
- 在 JOIN 操作时，由于两个表的排序规则不一致，导致 MySQL 无法直接比较字段

### 解决方案
在 JOIN 条件中显式指定排序规则，使用 `COLLATE utf8mb4_unicode_ci` 统一排序规则：

```php
LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id COLLATE utf8mb4_unicode_ci
```

### 修改内容
在 `OrderReview.php` 模型的两个方法中添加排序规则指定：

1. **`getAll()` 方法（第32行）**
```php
LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id COLLATE utf8mb4_unicode_ci
```

2. **`searchWithFilters()` 方法（第113行）**
```php
LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id COLLATE utf8mb4_unicode_ci
```
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_type_id (type_id),
    INDEX idx_code (code),
    INDEX idx_logistics_provider_id (logistics_provider_id),
    INDEX idx_wid (wid),
    INDEX idx_is_used (is_used)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物流渠道';
```

## 实现方案

### 1. 修改 OrderReview 模型

#### 修改 `getAll()` 方法
添加 LEFT JOIN 关联查询，获取物流渠道的code：

```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name, l.code 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id 
            ORDER BY orr.id DESC";
    $params = [];
    
    if ($limit !== null) {
        $sql .= " LIMIT ? OFFSET ?";
        $params[] = $limit;
        $params[] = $offset;
    }
    
    $stmt = $this->db->query($sql, $params);
    return $stmt->fetchAll();
}
```

**关键点：**
- 添加 `LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id` 关联查询
- 使用表别名 `l` 简化SQL语句
- 同时查询 `code` 字段

#### 修改 `searchWithFilters()` 方法
在搜索查询中也添加物流信息关联，并支持按物流渠道编码搜索：

```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name, l.code 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id 
            WHERE 1=1";
    $params = [];
    
    if (!empty($keyword)) {
        $sql .= " AND (orr.global_order_no LIKE ? OR orr.local_sku LIKE ? OR orr.receiver_country_code LIKE ? OR s.platform_name LIKE ? OR s.store_name LIKE ? OR w.wp_name LIKE ? OR l.code LIKE ?)";
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
    }
    
    // ... 其他筛选条件
}
```

**关键点：**
- 在关键词搜索中添加 `l.code` 的搜索
- 所有字段引用都添加表别名前缀，避免字段名冲突

### 2. 修改 index.php 视图

#### 修改表头
将"物流方式ID（已设置）"改为"物流渠道编码"：

```php
<th>物流渠道编码</th>
```

#### 修改数据显示
显示物流渠道编码，使用 `htmlspecialchars()` 防止XSS攻击：

```php
<td><?php echo htmlspecialchars($review['code'] ?? ''); ?></td>
```

**关键点：**
- 使用 `code` 字段显示物流渠道编码
- 使用 `htmlspecialchars()` 防止XSS攻击
- 使用空合并运算符 `??` 处理空值情况

## 显示效果

### 修改前
```
| ID | 店铺         | ... | 物流方式ID（已设置） | ...
|----|--------------|-----|----------------------|----
| 1  | Amazon - 美国旗舰店 | ... | 1001                 | ...
| 2  | eBay - 英国专营店        | ... | 1002                 | ...
```

### 修改后
```
| ID | 店铺         | ... | 物流渠道编码 | ...
|----|--------------|-----|--------------|----
| 1  | Amazon - 美国旗舰店 | ... | FDXSPE       | ...
| 2  | eBay - 英国专营店        | ... | UPSGDE       | ...
```

## 修改内容

### OrderReview.php 模型

**第28行：修改 `getAll()` 方法**
```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name, l.code 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id 
            ORDER BY orr.id DESC";
    // ...
}
```

**第109行：修改 `searchWithFilters()` 方法**
```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name, l.code 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            LEFT JOIN logistics l ON orr.logistics_type_id = l.type_id 
            WHERE 1=1";
    // ...
}
```

### index.php 视图

**第131行：修改表头**
```php
<th>物流渠道编码</th>
```

**第181行：修改数据显示**
```php
<td><?php echo htmlspecialchars($review['code'] ?? ''); ?></td>
```

## 技术特点

1. **LEFT JOIN**：确保即使没有匹配的物流记录，订单记录也会返回
2. **数据安全**：使用 `htmlspecialchars()` 防止XSS攻击
3. **搜索增强**：支持按物流渠道编码进行关键词搜索
4. **表别名**：使用表别名简化SQL语句，避免字段名冲突
5. **空值处理**：使用空合并运算符 `??` 处理空值情况

## 用户体验提升

1. **可读性**：显示物流渠道编码，比物流方式ID更直观
2. **搜索便利**：可以通过物流渠道编码快速搜索订单
3. **容错性**：即使物流信息缺失，也能正常显示
4. **一致性**：所有查询方法都包含物流信息，确保数据一致性

## 影响文件

- `admin-panel/models/OrderReview.php`
- `admin-panel/views/order_review/index.php`

## 测试建议

测试以下场景：
1. 有完整物流信息的订单（显示物流渠道编码）
2. 没有物流信息的订单（显示空）
3. 按物流渠道编码搜索订单
4. 分页查询的物流信息显示
5. 筛选条件下的物流信息显示
