# 2026-01-12 添加各平台月度销售额统计

## 更新内容

在dashboard.php中添加了各平台月度销售额统计功能，显示每个平台的本月销售额、上月销售额、上上月销售额以及上月对比上上月的销售额增长率。

## 修改文件

1. **`admin-panel/models/OrderProfit.php`**：添加了`getPlatformMonthlySalesStats`方法
2. **`admin-panel/controllers/AuthController.php`**：调用新方法并传递数据到视图
3. **`admin-panel/views/dashboard.php`**：添加了HTML表格显示统计数据

## 具体修改

1. **在OrderProfit模型中添加月度销售额统计方法**：
```php
// 获取各个平台的月度销售额统计数据
public function getPlatformMonthlySalesStats() {
    // 获取本月、上月、上上月的年份和月份
    $currentYearMonth = date('Y-m');
    $lastYearMonth = date('Y-m', strtotime('-1 month'));
    $lastLastYearMonth = date('Y-m', strtotime('-2 month'));
    
    // 构建SQL查询
    $sql = "SELECT 
                s.platform_name,
                SUM(CASE WHEN DATE_FORMAT(op.global_purchase_time, '%Y-%m') = ? THEN CAST(...) END) as current_month_sales,
                SUM(CASE WHEN DATE_FORMAT(op.global_purchase_time, '%Y-%m') = ? THEN CAST(...) END) as last_month_sales,
                SUM(CASE WHEN DATE_FORMAT(op.global_purchase_time, '%Y-%m') = ? THEN CAST(...) END) as last_last_month_sales
            FROM order_profit op
            LEFT JOIN store s ON op.store_id = s.store_id
            WHERE DATE(op.global_purchase_time) BETWEEN ? AND ?
            GROUP BY s.platform_name
            ORDER BY s.platform_name ASC";
    
    // 处理结果，计算增长率
    // ...
}
```

2. **在AuthController中调用该方法**：
```php
// 获取各平台月度销售额统计数据
$platformMonthlyStats = $orderProfitModel->getPlatformMonthlySalesStats();
```

3. **在dashboard.php中添加HTML表格**：
```html
<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead class="thead-light">
            <tr>
                <th>平台名称</th>
                <th>本月销售额</th>
                <th>上月销售额</th>
                <th>上上月销售额</th>
                <th>上月对比上上月增长率</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($platformMonthlyStats as $stat): ?>
                <tr>
                    <td><?php echo htmlspecialchars($stat['platform_name']); ?></td>
                    <td>$<?php echo number_format($stat['current_month_sales'], 2); ?></td>
                    <td>$<?php echo number_format($stat['last_month_sales'], 2); ?></td>
                    <td>$<?php echo number_format($stat['last_last_month_sales'], 2); ?></td>
                    <td>
                        <span class="<?php echo $stat['growth_rate'] > 0 ? 'text-success' : ($stat['growth_rate'] < 0 ? 'text-danger' : 'text-muted'); ?>">
                            <?php echo $stat['growth_rate'] > 0 ? '+' : ''; ?>
                            <?php echo number_format($stat['growth_rate'], 2) . '%'; ?>
                        </span>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>
```

## 效果

- 新增的月度销售额统计表显示在dashboard页面顶部
- 表格包含平台名称、本月销售额、上月销售额、上上月销售额和增长率五个字段
- 增长率使用颜色区分：正数为绿色，负数为红色，零为灰色
- 销售额数据格式化为美元货币格式，保留两位小数
- 表格具有响应式设计，在小屏幕设备上也能良好显示
- 支持分页和排序（使用Bootstrap表格默认功能）

## 技术细节

- 使用SQL的CASE语句实现月度数据的条件聚合
- 通过计算日期范围确保只查询需要的数据
- 增长率计算使用公式：(上月销售额 - 上上月销售额) / 上上月销售额 × 100%
- 增长率为零时显示为0.00%，避免除以零错误
- 使用htmlspecialchars函数防止XSS攻击
- 表格使用Bootstrap样式，与系统整体风格保持一致

## 数据处理

- 从order_profit表获取销售数据
- 关联store表获取平台名称
- 使用CAST和REPLACE函数处理货币格式的销售额数据
- 按平台名称分组聚合
- 计算并格式化增长率数据