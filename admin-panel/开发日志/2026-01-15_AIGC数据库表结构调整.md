# AIGC数据库表结构调整记录

## 修改时间
2026-01-15

## 修改内容

### 1. 删除`aigc_templates`表
- 原因：根据业务需求，不再需要模板功能
- 操作：直接删除该表
- 影响：所有基于模板的功能将不再可用

### 2. 合并`aigc_task_results`表到`aigc_tasks`表
- 原因：简化数据库结构，减少表之间的关联查询
- 操作：
  - 在`aigc_tasks`表中添加以下字段：
    - `original_filename`：原始文件名
    - `original_path`：原始文件路径
    - `process_status`：处理状态（success/failed）
    - `result_url`：处理结果图像URL
    - `error_message`：错误信息
  - 删除原`aigc_task_results`表

### 3. 数据存储策略调整
- 原因：优化存储效率，避免存储大量base64数据占用数据库空间
- 操作：
  - 将原`result_data`字段（存储base64编码的图像数据）替换为`result_url`字段（仅存储图像URL）
  - 图像实际存储在阿里云OSS，数据库仅保存临时访问链接（有效期24小时）

## 字段变更详情

### aigc_tasks表新增字段
| 字段名 | 类型 | 描述 |
|-------|------|------|
| original_filename | VARCHAR(255) | 原始文件名 |
| original_path | VARCHAR(255) | 原始文件路径 |
| process_status | ENUM('success', 'failed') | 处理状态 |
| result_url | VARCHAR(255) | 处理结果图像URL |
| error_message | TEXT | 错误信息 |

### 字段名称变更
| 原字段名 | 新字段名 | 原因 |
|---------|--------|------|
| status | task_status | 避免与新增的process_status字段混淆 |

### 索引调整
| 原索引 | 新索引 | 原因 |
|-------|------|------|
| idx_user_status (user_id, status) | idx_user_status (user_id, task_status) | 适配字段名称变更 |
| - | idx_process_status (process_status) | 新增索引，提升处理状态查询效率 |

## 影响范围
1. **后端代码**：需要更新所有涉及AIGC任务和结果的数据库操作
2. **前端代码**：需要更新结果展示逻辑，直接使用URL访问图像
3. **API接口**：需要更新返回结果格式，提供图像URL而非base64数据

## 注意事项
1. 由于不再存储base64数据，前端需要确保能够处理图像URL的加载
2. 图像URL有效期为24小时，需要在有效期内使用或保存图像
3. 数据库迁移时需要确保现有数据的正确转换或清理