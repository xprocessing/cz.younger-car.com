# 2026-01-12 - 修复字符集冲突问题

## 问题描述
系统抛出Fatal error：
`Uncaught PDOException: SQLSTATE[HY000]: General error: 1267 Illegal mix of collations (utf8mb4_unicode_ci,IMPLICIT) and (utf8mb4_general_ci,IMPLICIT) for operation '='`

错误发生在`/www/wwwroot/cz.younger-car.com/admin-panel/includes/database.php`第37行，具体是在`OrderProfit`模型的`getPlatformCostPercentage()`方法中执行SQL查询时。

## 问题分析
通过分析错误信息和代码，发现问题出在以下SQL查询中：
```sql
SELECT s.platform_name, SUM(c.cost) as total_cost
FROM costs c
LEFT JOIN store s ON c.store_name = s.store_name
WHERE 1=1
```

**根本原因**：`costs`表和`store`表的`store_name`字段使用了不同的字符集排序规则（collation）：
- `costs`表的`store_name`字段使用了`utf8mb4_general_ci`
- `store`表的`store_name`字段使用了`utf8mb4_unicode_ci`

当在SQL查询中比较这两个字段时，MySQL无法处理不同排序规则之间的比较，因此抛出了字符集冲突错误。

## 解决方案
在SQL查询的连接条件中显式指定字符集排序规则，确保两个字段使用相同的排序规则进行比较：

```sql
SELECT s.platform_name, SUM(c.cost) as total_cost
FROM costs c
LEFT JOIN store s ON c.store_name COLLATE utf8mb4_unicode_ci = s.store_name COLLATE utf8mb4_unicode_ci
WHERE 1=1
```

### 修改的文件
- `admin-panel/models/OrderProfit.php`

### 修改的方法
- `getPlatformCostPercentage($startDate, $endDate)`：在LEFT JOIN连接条件中添加了COLLATE子句

## 验证结果
修复后，SQL查询能够正常执行，不会再抛出字符集冲突错误。各平台广告费占比饼图可以正常显示数据。

## 后续优化建议
1. 统一数据库中所有表的字符集和排序规则，避免类似的冲突
2. 在数据库设计阶段明确指定字符集和排序规则
3. 定期检查数据库表的字符集一致性