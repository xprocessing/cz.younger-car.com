# 2026-02-02 批量审核订单系统增加每小时自动处理功能

## 需求描述

在批量审核订单系统的GUI界面中，增加"每小时处理一次"按钮，实现每小时自动执行批量审核订单的功能，减少人工操作，提高工作效率。

## 实现方案

### 1. 添加GUI按钮

在控制中心区域添加"每小时处理一次"按钮：

```python
# 每小时处理一次按钮
self.hourly_process_var = tk.StringVar(value="每小时处理一次")
self.hourly_button = ttk.Button(self.control_frame, textvariable=self.hourly_process_var, command=self.toggle_hourly_process)
self.hourly_button.pack(side=tk.LEFT, padx=5)
self.hourly_running = False
self.hourly_timer = None
```

**关键点：**
- 使用 `StringVar` 动态更新按钮文本
- `hourly_running` 标志控制每小时处理状态
- `hourly_timer` 保存定时器线程引用

### 2. 切换功能实现

添加 `toggle_hourly_process` 方法，用于启动和停止每小时处理：

```python
def toggle_hourly_process(self):
    """
    切换每小时自动处理状态
    """
    if self.hourly_running:
        self.stop_hourly_process()
    else:
        self.start_hourly_process()
```

### 3. 启动每小时处理

添加 `start_hourly_process` 方法，实现每小时自动处理的核心逻辑：

```python
def start_hourly_process(self):
    """
    开始每小时自动处理
    """
    self.hourly_running = True
    self.hourly_process_var.set("停止每小时处理")
    self.status_var.set("每小时处理模式已启动")
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 每小时自动处理模式已启动")
    
    def hourly_task():
        while self.hourly_running:
            try:
                print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 开始执行每小时自动处理...")
                self.start_process()
                
                # 等待当前处理完成
                if hasattr(self, 'process_thread') and self.process_thread.is_alive():
                    self.process_thread.join()
                
                print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 本次处理完成，等待下一次处理...")
                
                # 等待1小时（3600秒）
                for _ in range(360):
                    if not self.hourly_running:
                        break
                    time.sleep(10)
                
            except Exception as e:
                print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 每小时处理出错: {str(e)}")
                time.sleep(60)
    
    self.hourly_timer = threading.Thread(target=hourly_task, daemon=True)
    self.hourly_timer.start()
```

**功能特点：**
- 自动调用 `start_process()` 执行批量审核
- 等待当前处理完成后再等待下一次
- 使用分步等待（每10秒检查一次）确保可以快速响应停止操作
- 异常处理：出错后等待1分钟再重试

### 4. 停止每小时处理

添加 `stop_hourly_process` 方法，用于停止每小时处理：

```python
def stop_hourly_process(self):
    """
    停止每小时自动处理
    """
    self.hourly_running = False
    self.hourly_process_var.set("每小时处理一次")
    self.status_var.set("每小时处理模式已停止")
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 每小时自动处理模式已停止")
    
    if hasattr(self, 'process_thread') and self.process_thread.is_alive():
        self.stop_process()
```

**功能特点：**
- 设置标志位停止定时器循环
- 恢复按钮文本为"每小时处理一次"
- 如果当前正在处理订单，同时停止处理

### 5. 窗口关闭保护

添加窗口关闭事件处理，防止在每小时处理运行时意外关闭：

```python
def on_closing():
    """
    窗口关闭事件处理
    """
    if app.hourly_running:
        if messagebox.askokcancel("退出", "每小时处理正在运行，确定要退出吗？"):
            app.stop_hourly_process()
            root.destroy()
    else:
        root.destroy()

root.protocol("WM_DELETE_WINDOW", on_closing)
```

**功能特点：**
- 检测每小时处理是否正在运行
- 如果正在运行，弹出确认对话框
- 确认后先停止每小时处理，再关闭窗口

## 使用说明

### 启动每小时处理
1. 点击"每小时处理一次"按钮
2. 按钮文本变为"停止每小时处理"
3. 系统立即执行一次批量审核
4. 处理完成后，等待1小时自动执行下一次

### 停止每小时处理
1. 点击"停止每小时处理"按钮
2. 按钮文本恢复为"每小时处理一次"
3. 当前正在处理的订单会完成
4. 停止后不再自动执行

### 关闭程序
1. 如果每小时处理正在运行，会弹出确认对话框
2. 确认后会停止每小时处理并关闭程序
3. 如果每小时处理未运行，直接关闭程序

## 修改内容

### 第86-92行：添加每小时处理按钮
```python
# 每小时处理一次按钮
self.hourly_process_var = tk.StringVar(value="每小时处理一次")
self.hourly_button = ttk.Button(self.control_frame, textvariable=self.hourly_process_var, command=self.toggle_hourly_process)
self.hourly_button.pack(side=tk.LEFT, padx=5)
self.hourly_running = False
self.hourly_timer = None
```

### 第235-287行：实现每小时处理功能
- `toggle_hourly_process()`：切换每小时处理状态
- `start_hourly_process()`：启动每小时自动处理
- `stop_hourly_process()`：停止每小时自动处理

### 第739-750行：添加窗口关闭保护
```python
def on_closing():
    """
    窗口关闭事件处理
    """
    if app.hourly_running:
        if messagebox.askokcancel("退出", "每小时处理正在运行，确定要退出吗？"):
            app.stop_hourly_process()
            root.destroy()
    else:
        root.destroy()

root.protocol("WM_DELETE_WINDOW", on_closing)
```

## 技术特点

1. **线程安全**：使用独立的线程执行每小时任务，不阻塞主界面
2. **快速响应**：使用分步等待（每10秒检查一次），确保停止操作快速响应
3. **异常处理**：出错后自动重试，保证系统稳定性
4. **状态同步**：按钮文本和状态标签实时更新，用户可清楚了解当前状态
5. **防误操作**：关闭窗口时进行确认，防止意外中断处理

## 影响文件

- `review_order/batch_review_orde_gui.v2.py`

## 用户体验提升

1. **自动化**：无需人工干预，系统每小时自动处理订单
2. **灵活性**：可随时启动或停止每小时处理
3. **可视化**：按钮文本和状态标签清晰显示当前状态
4. **安全性**：关闭程序时有确认提示，防止误操作
5. **稳定性**：异常处理机制确保系统稳定运行

## 测试建议

测试以下场景：
1. 启动每小时处理，观察是否立即执行一次
2. 观察等待1小时后是否自动执行下一次
3. 在等待过程中停止每小时处理
4. 在处理过程中停止每小时处理
5. 每小时处理运行时关闭窗口（确认和取消）
6. 每小时处理未运行时关闭窗口
7. 模拟处理出错，观察是否自动重试
