# 2026-02-02 订单审核列表页面仓库名称显示优化

## 需求描述

在订单审核列表页面中，将"仓库ID（已设置）"列改为显示"仓库名称"，通过仓库的 `wid` 关联 `warehouses` 数据表中的 `wp_name` 字段，提升数据的可读性和用户体验。

## 数据表结构

### order_review 表
```sql
CREATE TABLE IF NOT EXISTS `order_review` (
    `id` INTEGER NOT NULL AUTO_INCREMENT UNIQUE,
    `store_id` CHAR(50) COMMENT '店铺id',
    `wid` INT DEFAULT NULL COMMENT '仓库wid',
    ...
    PRIMARY KEY(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单审核';
```

### warehouses 表
```sql
CREATE TABLE IF NOT EXISTS warehouses (
    wid INT PRIMARY KEY,
    type INT NOT NULL,
    sub_type INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    is_delete INT NOT NULL,
    country_code VARCHAR(10),
    wp_id INT,
    wp_name VARCHAR(50),
    t_warehouse_name VARCHAR(50),
    t_warehouse_code VARCHAR(50),
    t_country_area_name VARCHAR(50),
    t_status VARCHAR(10)
);
```

## 实现方案

### 1. 修改 OrderReview 模型

#### 修改 `getAll()` 方法
添加 LEFT JOIN 关联查询，获取仓库的wp_name：

```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            ORDER BY orr.id DESC";
    $params = [];
    
    if ($limit !== null) {
        $sql .= " LIMIT ? OFFSET ?";
        $params[] = $limit;
        $params[] = $offset;
    }
    
    $stmt = $this->db->query($sql, $params);
    return $stmt->fetchAll();
}
```

**关键点：**
- 添加 `LEFT JOIN warehouses w ON orr.wid = w.wid` 关联查询
- 使用表别名 `w` 简化SQL语句
- 同时查询 `wp_name` 字段

#### 修改 `searchWithFilters()` 方法
在搜索查询中也添加仓库信息关联，并支持按仓库名称搜索：

```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            WHERE 1=1";
    $params = [];
    
    if (!empty($keyword)) {
        $sql .= " AND (orr.global_order_no LIKE ? OR orr.local_sku LIKE ? OR orr.receiver_country_code LIKE ? OR s.platform_name LIKE ? OR s.store_name LIKE ? OR w.wp_name LIKE ?)";
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
        $params[] = '%' . $keyword . '%';
    }
    
    // ... 其他筛选条件
}
```

**关键点：**
- 在关键词搜索中添加 `w.wp_name` 的搜索
- 所有字段引用都添加表别名前缀，避免字段名冲突

### 2. 修改 index.php 视图

#### 修改表头
将"仓库ID（已设置）"改为"仓库名称"：

```php
<th>仓库名称</th>
```

#### 修改数据显示
显示仓库名称，使用 `htmlspecialchars()` 防止XSS攻击：

```php
<td><?php echo htmlspecialchars($review['wp_name'] ?? ''); ?></td>
```

**关键点：**
- 使用 `wp_name` 字段显示仓库名称
- 使用 `htmlspecialchars()` 防止XSS攻击
- 使用空合并运算符 `??` 处理空值情况

## 显示效果

### 修改前
```
| ID | 店铺         | ... | 仓库ID（已设置） | ...
|----|--------------|-----|-------------------|----
| 1  | Amazon - 美国旗舰店 | ... | 5830              | ...
| 2  | eBay - 英国专营店        | ... | 6568              | ...
```

### 修改后
```
| ID | 店铺         | ... | 仓库名称       | ...
|----|--------------|-----|-----------------|----
| 1  | Amazon - 美国旗舰店 | ... | may_auto_store-US美国仓(AWD) | ...
| 2  | eBay - 英国专营店        | ... | YoungerCar-US美国仓(AWD) | ...
```

## 修改内容

### OrderReview.php 模型

**第28行：修改 `getAll()` 方法**
```php
public function getAll($limit = null, $offset = 0) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            ORDER BY orr.id DESC";
    // ...
}
```

**第108行：修改 `searchWithFilters()` 方法**
```php
public function searchWithFilters($keyword, $reviewStatus, $startDate, $endDate, $limit, $offset) {
    $sql = "SELECT orr.*, s.platform_name, s.store_name, w.wp_name 
            FROM order_review orr 
            LEFT JOIN store s ON orr.store_id = s.store_id COLLATE utf8mb4_unicode_ci 
            LEFT JOIN warehouses w ON orr.wid = w.wid 
            WHERE 1=1";
    // ...
}
```

### index.php 视图

**第130行：修改表头**
```php
<th>仓库名称</th>
```

**第180行：修改数据显示**
```php
<td><?php echo htmlspecialchars($review['wp_name'] ?? ''); ?></td>
```

## 技术特点

1. **LEFT JOIN**：确保即使没有匹配的仓库记录，订单记录也会返回
2. **数据安全**：使用 `htmlspecialchars()` 防止XSS攻击
3. **搜索增强**：支持按仓库名称进行关键词搜索
4. **表别名**：使用表别名简化SQL语句，避免字段名冲突
5. **空值处理**：使用空合并运算符 `??` 处理空值情况

## 用户体验提升

1. **可读性**：显示仓库名称，比仓库ID更直观
2. **搜索便利**：可以通过仓库名称快速搜索订单
3. **容错性**：即使仓库信息缺失，也能正常显示
4. **一致性**：所有查询方法都包含仓库信息，确保数据一致性

## 影响文件

- `admin-panel/models/OrderReview.php`
- `admin-panel/views/order_review/index.php`

## 测试建议

测试以下场景：
1. 有完整仓库信息的订单（显示仓库名称）
2. 没有仓库信息的订单（显示空）
3. 按仓库名称搜索订单
4. 分页查询的仓库信息显示
5. 筛选条件下的仓库信息显示
