# 2026-01-16 修复APP_ROOT路径一致性问题

## 问题概述

修复了AIGC模块中出现的路径不一致问题，导致系统出现以下错误：

```
Warning: require_once(/www/wwwroot/cz.younger-car.com/admin-panel/admin-panel/config/config.php): Failed to open stream: No such file or directory
```

## 核心问题

系统中对APP_ROOT的定义不一致：
- `dashboard.php`等核心文件使用`__DIR__`包含配置，预期APP_ROOT指向admin-panel目录
- 但在修复过程中，APP_ROOT被错误地定义为项目根目录，导致路径重复

## 修复内容

### 1. 重新定义APP_ROOT

**修改文件**：`admin-panel/config/config.php`

确保APP_ROOT始终指向admin-panel目录：

```php
if (!defined('APP_ROOT')) {
    // APP_ROOT指向admin-panel目录，与dashboard.php使用__DIR__的预期一致
    define('APP_ROOT', dirname(__DIR__));
}
```

### 2. 更新目录路径定义

**修改文件**：`admin-panel/config/config.php`

更新PUBLIC_DIR和VIEWS_DIR的定义，使其与新的APP_ROOT一致：

```php
define('PUBLIC_DIR', APP_ROOT . '/public');
define('VIEWS_DIR', APP_ROOT . '/views');
```

### 3. 修复各文件中的路径

#### AIGCController.php
- 将绝对路径替换回使用VIEWS_DIR

#### AIGC.php
- 修正配置文件、数据库文件和日志文件的路径

#### Logger.php
- 修正日志目录路径

#### helpers/functions.php
- 修正Permission和Role模型的路径

#### scripts/process_images_worker.php
- 修正APP_ROOT定义
- 更新包含文件的路径

## 修复结果

通过统一APP_ROOT的定义，现在所有文件都使用一致的路径，系统不再出现路径重复或找不到文件的错误。修复后，系统可以正常运行：

- 仪表盘页面
- AI图片处理模块
- 权限检查功能
- 异步图片处理脚本

## 教训总结

1. **保持路径一致性**：在整个系统中使用统一的路径定义方式
2. **尊重现有代码约定**：不要轻易改变核心常量的定义，除非有充分的理由
3. **充分测试**：修复后需要测试所有相关功能，确保没有引入新的问题
4. **逐步修复**：不要同时修改多个文件，应该逐步修复并测试