# API参数优化记录 - 2026-01-15

## 问题分析

之前的API调用返回以下错误：
1. `DataInspectionFailed` - 内容审核失败
2. `InvalidParameter` - 参数格式错误
3. `x-dashscope-sse and stream parameter mismatch` - SSE头与stream参数不匹配

## 优化内容

### 1. 提示词优化
- 简化提示词，使用更中立的表述
- 避免可能触发内容审核的词汇
- 格式："图片处理任务：[具体要求]"

### 2. API参数结构调整
- 模型名称：从`qwen-image`改为`wan2.6-image`
- 参数格式：使用`input.messages`结构替代直接的`input.prompt`
- 内容结构：支持文本和图片的组合输入
- 图片数据：支持Base64编码格式

### 3. 新增必要参数
- `stream: true` - 启用流式响应
- `x-dashscope-sse: enable` - 添加SSE支持头

### 4. 参数优化
- `prompt_extend: true` - 启用提示词扩展
- `watermark: false` - 不添加水印
- `n: 1` - 生成1张图片
- `size: '1024*1024'` - 设置图片尺寸

### 5. 移除弃用功能
- 移除了`curl_close()`函数调用，PHP 8.0+自动释放资源

## 最终API请求格式

```json
{
    "model": "wan2.6-image",
    "input": {
        "messages": [
            {
                "role": "user",
                "content": [
                    {"text": "图片处理任务：[具体要求]"},
                    {"image": "base64编码的图片数据"} // 可选
                ]
            }
        ]
    },
    "parameters": {
        "prompt_extend": true,
        "watermark": false,
        "n": 1,
        "enable_interleave": true,
        "size": "1024*1024",
        "stream": true
    }
}
```

## 请求头

```
Content-Type: application/json
Authorization: Bearer [API_KEY]
x-dashscope-sse: enable
```

## 测试结果

- ✅ 参数格式错误已解决
- ✅ SSE头与stream参数不匹配问题已解决
- ⚠️ 当前返回500超时错误，可能是网络或服务端问题

## 后续建议

1. 增加API调用超时时间（当前设置为300秒）
2. 实现API调用失败重试机制
3. 检查网络连接和API密钥有效性
4. 监控API服务状态