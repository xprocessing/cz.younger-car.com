# 2026-01-29-运德渠道代码分批查询功能

## 更新概述
为运德运费试算接口实现了分批查询功能，当运德渠道代码数量超过10个时，自动分批执行查询，每批最多10个渠道，批次之间间隔10秒，避免请求过于频繁导致接口限流。

## 更新内容

### 1. 分批查询逻辑
在步骤6（计算运德运费）中，实现了分批查询功能：

#### 1.1 批次计算
- 设置批次大小（batch_size）为10个渠道
- 计算总批次数：`(渠道总数 + 9) // 10`

#### 1.2 分批执行
- 循环执行每一批查询
- 每批最多查询10个渠道代码
- 使用切片获取当前批次的渠道代码：`wd_channel_codes[start_idx:end_idx]`

#### 1.3 间隔控制
- 批次之间间隔10秒（`time.sleep(10)`）
- 避免请求过于频繁导致接口限流

#### 1.4 数据合并
- 使用`wd_fee_list.extend(batch_fee_list)`合并每批的查询结果
- 所有批次查询完成后，统一进行最小运费计算

### 2. 日志输出优化
增加了详细的日志输出，方便监控分批查询进度：

```python
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 运德渠道数量：{len(wd_channel_codes)}")
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 调用运德运费试算接口（第{i+1}/{total_batches}批，渠道数：{len(batch_channels)}）...")
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 第{i+1}批运费试算结果：{len(batch_fee_list)}条")
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 等待10秒后继续下一批查询...")
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 运德运费试算结果总计：{len(wd_fee_list)}条")
```

### 3. 代码实现
```python
wd_fee_list = []
batch_size = 10
total_batches = (len(wd_channel_codes) + batch_size - 1) // batch_size

for i in range(total_batches):
    start_idx = i * batch_size
    end_idx = min((i + 1) * batch_size, len(wd_channel_codes))
    batch_channels = wd_channel_codes[start_idx:end_idx]
    
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 调用运德运费试算接口（第{i+1}/{total_batches}批，渠道数：{len(batch_channels)}）...")
    batch_fee_list = review_order.get_wd_ship_fee(
        channels=",".join(batch_channels),
        country=receiver_country_code,
        city=city,
        postcode=postal_code,
        weight=weight,
        length=length,
        width=width,
        height=height,
        signatureService=0
    )
    wd_fee_list.extend(batch_fee_list)
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 第{i+1}批运费试算结果：{len(batch_fee_list)}条")
    
    if i < total_batches - 1:
        print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 等待10秒后继续下一批查询...")
        time.sleep(10)

time.sleep(3)
print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] 运德运费试算结果总计：{len(wd_fee_list)}条")
wd_ship_result = self.get_min_fee_shipment(wd_fee_list, wd_logistics)
```

## 修改文件
- `batch_review_orde_gui.py`

## 修改位置
- 行 448-483: 运德运费试算分批查询逻辑实现

## 功能说明
1. **自动分批**：当运德渠道代码数量超过10个时，自动分批查询
2. **批次控制**：每批最多查询10个渠道代码
3. **间隔控制**：批次之间间隔10秒，避免接口限流
4. **数据合并**：所有批次查询完成后，统一合并结果进行最小运费计算
5. **进度监控**：详细的日志输出，方便监控分批查询进度

## 优势
- 避免一次性查询过多渠道导致接口限流
- 提高查询成功率
- 便于监控查询进度
- 确保所有渠道都能被查询到