# 批量审核订单系统 - 代码说明文档

## 目录
1. [系统概述](#系统概述)
2. [技术架构](#技术架构)
3. [核心类说明](#核心类说明)
4. [功能模块详解](#功能模块详解)
5. [业务流程](#业务流程)
6. [配置说明](#配置说明)
7. [使用指南](#使用指南)

---

## 系统概述

批量审核订单系统是一个基于Python Tkinter开发的图形界面应用程序，用于自动化处理订单审核流程。系统通过调用外部API获取店铺、物流渠道、订单和库存信息，自动计算最优运费方案，并批量修改订单的物流配置。

### 主要功能
- 自动获取店铺列表、物流渠道列表、订单列表
- 根据订单SKU查询库存信息
- 智能匹配物流渠道（支持Amazon、eBay、Shopify平台）
- 自动计算中邮和运德运费
- 运德渠道代码分批查询（每批最多10个，间隔10秒）
- 自动选择最优运费方案
- 批量修改订单物流配置
- 实时日志输出和进度监控
- 结果统计和展示

---

## 技术架构

### 技术栈
- **GUI框架**: Python Tkinter + ttk
- **多线程**: threading模块（处理线程、日志线程、监控线程）
- **日志系统**: queue.Queue实现异步日志
- **时间处理**: datetime模块
- **外部接口**: review_order_func模块

### 系统架构图
```
┌─────────────────────────────────────────────────────────┐
│                  GUI主界面                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │ 控制中心  │  │ 处理进度  │  │ 处理日志  │ │
│  └──────────┘  └──────────┘  └──────────┘ │
│  ┌──────────────────────────────────────┐        │
│  │         处理结果展示区             │        │
│  │  ┌────┐ ┌────┐ ┌──────────┐ │        │
│  │  │统计│ │进度│ │  结果表格 │ │        │
│  │  └────┘ └────┘ └──────────┘ │        │
│  └──────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│              业务处理层                          │
│  ┌──────────────────────────────────────────┐       │
│  │      process_orders() 主处理流程        │       │
│  └──────────────────────────────────────────┘       │
│                    │                            │
│                    ▼                            │
│  ┌──────────────────────────────────────────┐       │
│  │   process_single_order() 单订单处理     │       │
│  └──────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│              数据访问层                          │
│  review_order_func 模块                           │
│  - get_store_list()                               │
│  - get_logistics_list()                           │
│  - get_orders_list()                              │
│  - get_inventory_details()                         │
│  - get_ems_product_spec()                         │
│  - get_wd_product_spec()                          │
│  - get_ems_ship_fee()                             │
│  - get_wd_ship_fee()                             │
│  - edit_order()                                   │
└─────────────────────────────────────────────────────────┘
```

---

## 核心类说明

### 1. LogRedirector 类

**功能**: 日志重定向类，将print输出重定向到GUI界面

**主要方法**:
- `__init__(text_widget)`: 初始化日志重定向器
- `write(text)`: 将文本写入队列
- `flush()`: 刷新缓冲区（空实现）
- `start()`: 启动日志处理线程
- `stop()`: 停止日志重定向，恢复标准输出

**工作原理**:
1. 拦截sys.stdout，将print输出重定向到队列
2. 启动后台线程从队列读取日志
3. 将日志插入到GUI的文本控件中
4. 自动滚动到最新日志位置

### 2. BatchReviewGUI 类

**功能**: 批量审核订单图形界面主类

**主要属性**:
```python
self.root                    # Tkinter根窗口
self.main_frame              # 主框架
self.control_frame           # 控制区框架
self.progress_frame          # 进度条框架
self.log_frame              # 日志区框架
self.result_frame           # 结果展示框架
self.result_tree            # 结果表格（Treeview）
self.process_thread         # 处理线程
self.stop_event            # 停止事件（threading.Event）
self.process_results       # 处理结果列表
self.log_redirector        # 日志重定向器
```

**主要方法**:

#### 初始化方法
- `__init__(root)`: 初始化GUI界面和所有组件

#### 控制方法
- `start_process()`: 开始批量审核订单
- `stop_process()`: 停止处理

#### 业务处理方法
- `process_orders()`: 处理订单的核心逻辑
- `process_single_order(order, store_list, logistics_list)`: 处理单个订单

#### 辅助方法
- `match_logistics_by_platform(platform_name, logistics_list)`: 根据平台匹配物流渠道
- `filter_logistics_by_wid(logistics_list, valid_wids)`: 根据仓库ID筛选物流渠道
- `filter_logistics_by_provider(logistics_list, provider_keyword)`: 根据物流商筛选
- `get_min_fee_shipment(ship_fee_list, logistics_list)`: 获取最小运费方案
- `update_results()`: 更新结果展示
- `monitor_process()`: 监控处理过程

---

## 功能模块详解

### 1. 日志重定向模块

**实现位置**: 行 14-48

**核心代码**:
```python
class LogRedirector:
    def __init__(self, text_widget):
        self.text_widget = text_widget
        self.old_stdout = sys.stdout
        self.queue = queue.Queue()
        self.running = True
    
    def write(self, text):
        self.queue.put(text)
    
    def start(self):
        def process_queue():
            while self.running:
                try:
                    text = self.queue.get(block=False)
                    if text:
                        self.text_widget.insert(tk.END, text)
                        self.text_widget.see(tk.END)
                except queue.Empty:
                    time.sleep(0.1)
        
        thread = threading.Thread(target=process_queue, daemon=True)
        thread.start()
```

**特点**:
- 异步处理，不阻塞主线程
- 自动滚动到最新日志
- 线程安全（使用队列）

### 2. GUI界面模块

**实现位置**: 行 50-173

**界面布局**:
```
┌─────────────────────────────────────────────┐
│ 控制中心                              │
│ [开始批量审核] [停止处理]   [状态: 就绪] │
├─────────────────────────────────────────────┤
│ 处理进度                              │
│ ████████████░░░░░░░░░░░░░░░  50%  │
│ 处理第 5/10 个订单                  │
├─────────────────────────────────────────────┤
│ 处理日志                              │
│ [2026-01-29 10:00:00] 开始处理...   │
│ [2026-01-29 10:00:01] 获取店铺...   │
│ ...                                    │
├─────────────────────────────────────────────┤
│ 处理结果                              │
│ 总订单数: 10  成功数: 8  失败数: 2 │
│ ┌─────────────────────────────────────┐   │
│ │ 订单号 | 状态 | 有货仓库 | ... │   │
│ │ 001     | 成功 | USWE     | ... │   │
│ │ 002     | 失败 | -        | ... │   │
│ └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

**结果表格列**:
1. 订单号 (order_no)
2. 状态 (status)
3. 有货仓库 (wid)
4. 可用渠道编码 (channel)
5. 运德产品规格 (wd_product_spec)
6. 中邮产品规格 (ems_product_spec)
7. 中邮邮费试算(元) (ems_fee)
8. 运德邮费试算(元) (wd_fee)
9. 最优运费(元) (fee)
10. 物流类型ID (type_id)
11. 消息 (message)

### 3. 订单处理模块

**实现位置**: 行 221-355

**主流程**:
```python
def process_orders(self):
    # 1. 初始化基础数据
    store_list = review_order.get_store_list()
    logistics_list = review_order.get_logistics_list()
    orders_list = review_order.get_orders_list()
    
    # 2. 筛选待处理订单
    target_orders = [order for order in orders_list if order.get("wid") == "0"]
    
    # 3. 遍历处理每个订单
    for idx, order in enumerate(target_orders, 1):
        order_result = self.process_single_order(order, store_list, logistics_list)
        self.process_results.append(order_result)
    
    # 4. 更新结果展示
    self.update_results()
```

### 4. 单订单处理模块

**实现位置**: 行 357-549

**处理步骤**:

#### 步骤1: 匹配店铺平台
```python
store_item = next((s for s in store_list if s.get("store_id") == store_id), None)
platform_name = store_item.get("platform_name")
```

#### 步骤2: 匹配物流渠道
```python
matched_logistics = self.match_logistics_by_platform(platform_name, logistics_list)
```

**平台匹配规则**:
- Amazon → 亚马逊物流渠道
- eBay → eBay物流渠道
- Shopify → 独立站物流渠道

#### 步骤3: 查询库存信息
```python
inventory_details = review_order.get_inventory_details(local_sku)
valid_wids = [item.get("wid") for item in inventory_details 
                if int(item.get("product_valid_num", 0)) > 0]
```

#### 步骤4: 筛选物流渠道
```python
filtered_logistics = self.filter_logistics_by_wid(matched_logistics, valid_wids)
```

#### 步骤5: 计算中邮运费
```python
ems_logistics = self.filter_logistics_by_provider(filtered_logistics, "中邮")
ems_spec = review_order.get_ems_product_spec(local_sku, platform_name)
ems_fee_list = review_order.get_ems_ship_fee(...)
ems_ship_result = self.get_min_fee_shipment(ems_fee_list, ems_logistics)
```

#### 步骤6: 计算运德运费（分批查询）
```python
wd_logistics = self.filter_logistics_by_provider(filtered_logistics, "运德")
wd_spec = review_order.get_wd_product_spec(local_sku, platform_name)

# 分批查询
batch_size = 10
total_batches = (len(wd_channel_codes) + batch_size - 1) // batch_size

for i in range(total_batches):
    batch_channels = wd_channel_codes[i*10 : (i+1)*10]
    batch_fee_list = review_order.get_wd_ship_fee(
        channels=",".join(batch_channels),
        ...
    )
    wd_fee_list.extend(batch_fee_list)
    if i < total_batches - 1:
        time.sleep(10)  # 批次间隔

wd_ship_result = self.get_min_fee_shipment(wd_fee_list, wd_logistics)
```

**分批查询特点**:
- 每批最多10个渠道代码
- 批次之间间隔10秒
- 自动合并所有批次结果
- 详细的进度日志

#### 步骤7: 选择最优运费
```python
compare_list = []

if ems_ship_result and ems_ship_result["currency"] == "CNY":
    compare_list.append({
        "type": "ems",
        "fee_cny": ems_ship_result["totalFee"],
        "detail": ems_ship_result
    })

if wd_ship_result and wd_ship_result["currency"] == "USD":
    wd_fee_cny = wd_ship_result["totalFee"] * USD_TO_CNY_RATE
    compare_list.append({
        "type": "wd",
        "fee_cny": wd_fee_cny,
        "detail": wd_ship_result
    })

min_compare = min(compare_list, key=lambda x: x["fee_cny"])
final_choice = min_compare["detail"]
```

#### 步骤8: 修改订单
```python
edit_result = review_order.edit_order(
    type_id=final_choice.get("type_id"),
    wid=final_choice.get("wid"),
    global_order_no=global_order_no
)

if edit_result.get("code") == 0:
    result["status"] = "success"
    result["final_fee"] = min_compare["fee_cny"]
    result["final_type_id"] = final_choice.get("type_id")
    result["final_wid"] = final_choice.get("wid")
    result["final_channel_code"] = final_choice.get("channel_code")
```

### 5. 辅助方法模块

#### match_logistics_by_platform
**实现位置**: 行 551-561

```python
def match_logistics_by_platform(self, platform_name, logistics_list):
    matched_logistics = []
    for logistics in logistics_list:
        logistics_provider = logistics.get("logistics_provider_name", "")
        if ("Amazon" in platform_name and "亚马逊" in logistics_provider) or \
           ("eBay" in platform_name and "eBay" in logistics_provider) or \
           ("Shopify" in platform_name and "独立站" in logistics_provider):
            matched_logistics.append(logistics)
    return matched_logistics
```

#### filter_logistics_by_wid
**实现位置**: 行 563-569

```python
def filter_logistics_by_wid(self, logistics_list, valid_wids):
    if not valid_wids:
        return []
    filtered = [log for log in logistics_list if log.get("wid") in valid_wids]
    return filtered
```

#### filter_logistics_by_provider
**实现位置**: 行 571-577

```python
def filter_logistics_by_provider(self, logistics_list, provider_keyword):
    filtered = [log for log in logistics_list 
                if provider_keyword in log.get("logistics_provider_name", "")]
    return filtered
```

#### get_min_fee_shipment
**实现位置**: 行 579-603

```python
def get_min_fee_shipment(self, ship_fee_list, logistics_list):
    # 过滤无效运费
    valid_fee_list = [item for item in ship_fee_list 
                    if item.get("totalFee") and float(item.get("totalFee")) > 0]
    
    # 找到最小运费
    min_fee_item = min(valid_fee_list, key=lambda x: float(x.get("totalFee")))
    min_channel_code = min_fee_item.get("channel_code")
    
    # 匹配物流信息
    matched_log = next((log for log in logistics_list 
                      if log.get("channel_code") == min_channel_code), None)
    
    return {
        "totalFee": float(min_fee_item.get("totalFee")),
        "currency": min_fee_item.get("currency"),
        "type_id": matched_log.get("type_id"),
        "wid": matched_log.get("wid"),
        "channel_code": min_channel_code
    }
```

#### update_results
**实现位置**: 行 605-626

```python
def update_results(self):
    # 更新统计
    total_orders = len(self.process_results)
    success_count = sum(1 for res in self.process_results 
                      if res.get("status") == "success")
    failed_count = total_orders - success_count
    
    # 更新表格
    for result in self.process_results:
        self.result_tree.insert("", tk.END, values=(
            result.get("global_order_no"),
            result.get("status"),
            result.get("final_wid", ""),
            result.get("final_channel_code", ""),
            result.get("wd_product_spec", ""),
            result.get("ems_product_spec", ""),
            result.get("ems_fee", 0),
            result.get("wd_fee", 0),
            result.get("final_fee", 0),
            result.get("final_type_id", ""),
            result.get("message", "")
        ))
```

#### monitor_process
**实现位置**: 行 628-634

```python
def monitor_process(self):
    while True:
        if not self.process_thread or not self.process_thread.is_alive():
            break
        time.sleep(0.5)
```

---

## 业务流程

### 完整业务流程图

```
开始
  │
  ▼
┌─────────────────────────┐
│ 1. 获取店铺列表        │
│    get_store_list()    │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 2. 获取物流渠道列表    │
│ get_logistics_list()   │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 3. 获取订单列表        │
│   get_orders_list()    │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 4. 筛选待处理订单     │
│   wid == "0"          │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5. 遍历处理订单        │
│   for each order       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.1 匹配店铺平台       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.2 匹配物流渠道       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.3 查询库存信息       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.4 筛选物流渠道       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.5 计算中邮运费       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.6 计算运德运费       │
│    (分批查询)          │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.7 选择最优运费       │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 5.8 修改订单          │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ 6. 更新结果展示        │
└─────────────────────────┘
  │
  ▼
结束
```

### 单订单处理详细流程

```
订单开始
  │
  ▼
┌─────────────────────────────────────┐
│ 提取订单信息                      │
│ - global_order_no                │
│ - local_sku                     │
│ - store_id                      │
│ - receiver_country_code           │
│ - city                          │
│ - postal_code                   │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ 步骤1: 匹配店铺平台               │
│ 根据store_id查找platform_name    │
└─────────────────────────────────────┘
  │ 失败
  ├──────────► 返回错误
  │
  ▼ 成功
┌─────────────────────────────────────┐
│ 步骤2: 匹配物流渠道               │
│ 根据platform_name筛选物流渠道     │
└─────────────────────────────────────┘
  │ 失败
  ├──────────► 返回错误
  │
  ▼ 成功
┌─────────────────────────────────────┐
│ 步骤3: 查询库存信息               │
│ 根据local_sku查询有货仓库       │
└─────────────────────────────────────┘
  │ 失败
  ├──────────► 返回错误
  │
  ▼ 成功
┌─────────────────────────────────────┐
│ 步骤4: 筛选物流渠道               │
│ 根据有货仓库筛选物流渠道         │
└─────────────────────────────────────┘
  │ 失败
  ├──────────► 返回错误
  │
  ▼ 成功
┌─────────────────────────────────────┐
│ 步骤5: 计算中邮运费               │
│ - 获取中邮产品规格                │
│ - 调用中邮运费试算接口           │
│ - 获取最小运费                   │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ 步骤6: 计算运德运费               │
│ - 获取运德产品规格                │
│ - 分批调用运德运费试算接口         │
│   (每批10个，间隔10秒)          │
│ - 合并所有批次结果                │
│ - 获取最小运费                   │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ 步骤7: 选择最优运费               │
│ - 比较中邮和运德运费             │
│ - 选择人民币最小运费               │
└─────────────────────────────────────┘
  │ 无有效运费
  ├──────────► 返回错误
  │
  ▼ 有有效运费
┌─────────────────────────────────────┐
│ 步骤8: 修改订单                  │
│ - 调用edit_order接口            │
│ - 更新type_id和wid             │
└─────────────────────────────────────┘
  │ 失败
  ├──────────► 返回错误
  │
  ▼ 成功
返回成功结果
```

---

## 配置说明

### 全局配置

```python
# 汇率配置：美元转人民币
USD_TO_CNY_RATE = 7.0
```

**说明**: 用于将运德运费（美元）转换为人民币，以便与中邮运费（人民币）进行比较。

### GUI配置

```python
# 窗口大小
self.root.geometry("1200x800")

# 窗口可调整大小
self.root.resizable(True, True)

# 主题
self.style.theme_use('clam')

# 字体配置
self.style.configure('TButton', font=('微软雅黑', 10), padding=6)
self.style.configure('TLabel', font=('微软雅黑', 10))
self.style.configure('TProgressbar', thickness=20)

# 日志字体
self.log_text = scrolledtext.ScrolledText(..., font=('Consolas', 9))
```

### 列宽配置

```python
self.result_tree.column("order_no", width=150)
self.result_tree.column("status", width=80)
self.result_tree.column("wid", width=100)
self.result_tree.column("channel", width=150)
self.result_tree.column("wd_product_spec", width=150)
self.result_tree.column("ems_product_spec", width=150)
self.result_tree.column("ems_fee", width=120)
self.result_tree.column("wd_fee", width=120)
self.result_tree.column("fee", width=100)
self.result_tree.column("type_id", width=120)
self.result_tree.column("message", width=200)
```

### 请求间隔配置

```python
# 店铺列表获取后
time.sleep(2)

# 物流渠道列表获取后
time.sleep(2)

# 订单列表获取后
time.sleep(2)

# 库存信息查询后
time.sleep(2)

# 中邮运费试算后
time.sleep(6)

# 中邮最小运费获取后
time.sleep(2)

# 运德每批查询后
time.sleep(10)  # 批次间隔

# 运德最小运费获取后
time.sleep(3)
```

---

## 使用指南

### 启动程序

```bash
python batch_review_orde_gui.py
```

### 操作步骤

1. **启动程序**
   - 运行程序后，会显示主界面
   - 状态显示"就绪"

2. **开始批量审核**
   - 点击"开始批量审核"按钮
   - 程序会自动执行以下操作：
     - 获取店铺列表
     - 获取物流渠道列表
     - 获取订单列表
     - 筛选待处理订单（wid=0）
     - 逐个处理订单

3. **监控处理进度**
   - 查看进度条了解总体进度
   - 查看进度信息了解当前处理状态
   - 查看日志了解详细处理过程

4. **查看处理结果**
   - 处理完成后，结果表格会显示所有订单的处理结果
   - 统计信息显示成功数和失败数

5. **停止处理**
   - 如需停止，点击"停止处理"按钮
   - 程序会停止当前订单的处理

### 结果说明

**成功订单**:
- 状态: "success"
- 显示最优运费
- 显示物流类型ID和仓库ID
- 显示产品规格和运费对比

**失败订单**:
- 状态: "failed"
- 显示失败原因
- 运费为0
- 物流信息为空

### 日志说明

日志格式:
```
[YYYY-MM-DD HH:MM:SS] 消息内容
```

日志内容:
- 处理开始/结束
- 数据获取结果
- 订单处理步骤
- 运费计算结果
- 错误信息
- 批次查询进度

### 注意事项

1. **请求频率控制**
   - 程序已内置请求间隔，避免请求过快
   - 运德渠道分批查询，每批间隔10秒

2. **错误处理**
   - 单个订单处理失败不会影响其他订单
   - 所有错误都会记录在日志中

3. **数据筛选**
   - 当前只处理wid=0的订单
   - 可根据需要修改筛选条件

4. **线程安全**
   - 使用多线程处理，避免界面卡顿
   - 日志重定向使用队列，线程安全

5. **资源释放**
   - 处理完成后会自动恢复标准输出
   - 停止日志重定向线程

---

## 扩展开发

### 添加新的物流商

1. 在`match_logistics_by_platform`方法中添加平台匹配规则
2. 在`process_single_order`方法中添加运费计算步骤
3. 在步骤7中添加新的运费比较逻辑

### 修改筛选条件

修改`process_orders`方法中的订单筛选逻辑:
```python
# 当前：筛选wid=0的订单
target_orders = [order for order in orders_list if order.get("wid") == "0"]

# 可修改为其他条件
target_orders = [order for order in orders_list if ...]
```

### 调整批次大小

修改`process_single_order`方法中的批次配置:
```python
# 当前：每批10个
batch_size = 10

# 可修改为其他大小
batch_size = 20
```

### 调整请求间隔

在各处`time.sleep()`调用中修改间隔时间

---

## 总结

批量审核订单系统是一个功能完善的自动化订单处理工具，具有以下特点：

**优点**:
- 图形界面友好，操作简单
- 多线程处理，不阻塞界面
- 实时日志输出，便于监控
- 智能分批查询，避免接口限流
- 自动选择最优运费，降低成本
- 详细的错误处理和日志记录

**适用场景**:
- 大量订单需要批量处理
- 需要对比不同物流商运费
- 需要自动化选择最优物流方案
- 需要实时监控处理进度

**技术亮点**:
- 异步日志重定向
- 多线程架构
- 智能分批查询
- 完善的错误处理
- 清晰的代码结构