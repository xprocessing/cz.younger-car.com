# 项目架构文档

## 1. 项目概述

本项目是一个基于原生 PHP 开发的后端管理平台，主要用于汽车零部件相关业务的管理，包括商品管理、库存管理、订单利润分析、运费管理等功能。项目采用了 MVC 架构模式，实现了完整的用户认证和 RBAC 权限管理系统。

## 2. 技术栈

### 后端
- **编程语言**: 原生 PHP (无框架)
- **数据库**: MySQL 5.7+
- **ORM**: 自定义简单 ORM (基于 PDO)
- **认证**: 基于会话 (Session) 的认证
- **权限管理**: RBAC (基于角色的访问控制)

### 前端
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **JavaScript**: 客户端交互
- **Bootstrap 5**: UI 框架
- **Font Awesome**: 图标库

### 开发工具与环境
- **开发环境**: Windows
- **Web 服务器**: Apache/Nginx
- **数据库管理**: phpMyAdmin/MySQL Workbench

## 3. 目录结构

项目采用模块化的目录结构，主要分为以下几个部分：

```
cz.younger-car.com/
├── admin-panel/           # 管理面板主目录
│   ├── controllers/       # 控制器层
│   ├── models/            # 模型层
│   ├── views/             # 视图层
│   ├── public/            # 公共资源
│   ├── includes/          # 包含文件
│   ├── helpers/           # 辅助函数
│   ├── database/          # 数据库脚本
│   ├── dingding/          # 钉钉通知
│   ├── scripts/           # 脚本文件
│   └── 开发日志/           # 开发日志
├── ebayfast/              # eBay 快捷工具
├── lingxing.com/          # 领星 ERP API 相关
├── xlingxing/             # 领星 API 集成
│   ├── php/               # PHP 版本的 API 客户端
│   └── python/            # Python 版本的 API 客户端
└── 项目架构文档.md         # 项目架构文档
```

### 核心目录详解

#### admin-panel/
管理面板的核心目录，采用 MVC 架构：

- **controllers/**: 控制器层，处理 HTTP 请求和业务逻辑
  - AuthController.php: 处理用户认证
  - UserController.php: 用户管理
  - RoleController.php: 角色管理
  - PermissionController.php: 权限管理
  - OrderProfitController.php: 订单利润管理
  - InventoryDetailsController.php: 库存明细管理
  - InventoryDetailsFbaController.php: FBA库存管理
  - ProductsController.php: 商品管理
  - NewProductController.php: 新产品开发管理
  - CompanyCostsController.php: 公司费用管理
  - ShopCostsController.php: 店铺费用管理
  - TrackCostsController.php: 赛道费用管理
  - CarDataController.php: 车型数据管理
  - StoreController.php: 店铺管理
  - WarehouseController.php: 仓库管理
  - YunfeiController.php: 运费管理
  - AIGCController.php: AI生成功能管理
  - QueryController.php: 查询功能管理

- **models/**: 模型层，处理数据访问和业务实体
  - User.php: 用户模型
  - Role.php: 角色模型
  - Permission.php: 权限模型
  - OrderProfit.php: 订单利润模型
  - InventoryDetails.php: 库存明细模型
  - InventoryDetailsFba.php: FBA库存模型
  - Product.php: 商品模型
  - Products.php: 商品管理模型
  - NewProduct.php: 新产品模型
  - CompanyCosts.php: 公司费用模型
  - ShopCosts.php: 店铺费用模型
  - TrackCosts.php: 赛道费用模型
  - TrackStatistics.php: 赛道统计模型
  - CarData.php: 车型数据模型
  - Store.php: 店铺模型
  - Warehouse.php: 仓库模型
  - Yunfei.php: 运费模型
  - AIGC.php: AI生成功能模型

- **views/**: 视图层，负责页面渲染
  - auth/: 认证相关视图
  - users/: 用户管理视图
  - roles/: 角色管理视图
  - permissions/: 权限管理视图
  - order_profit/: 订单利润视图
  - inventory_details/: 库存明细视图
  - inventory_details_fba/: FBA库存视图
  - products/: 商品管理视图
  - new_products/: 新产品开发视图
  - company_costs/: 公司费用视图
  - order_other_costs/: 订单其他费用视图
  - shop_costs/: 店铺费用视图
  - track_costs/: 赛道费用视图
  - car_data/: 车型数据视图
  - store/: 店铺管理视图
  - warehouses/: 仓库管理视图
  - yunfei/: 运费管理视图
  - aigc/: AI生成功能视图
  - query/: 查询功能视图
  - layouts/: 页面布局模板
  - dashboard.php: 仪表盘页面

- **public/**: 静态资源文件
  - css/: CSS 文件
  - js/: JavaScript 文件
  - fonts/: 字体文件
  - temp/: 临时文件
  - query/: 查询功能相关文件

- **includes/**: 通用包含文件
  - database.php: 数据库连接
  - RedisCache.php: Redis缓存
  - Logger.php: 日志记录

- **helpers/**: 辅助函数库
  - functions.php: 通用辅助函数

- **database/**: 数据库初始化和更新脚本
  - init.sql: 初始化数据库表结构
  - create_tables.php: 创建表结构
  - update_init_permissions.sql: 更新权限初始化
  - update_task_type_enum.sql: 更新任务类型枚举

- **dingding/**: 钉钉通知相关
  - ding_class.php: 钉钉通知类
  - ding_inventory.php: 库存钉钉通知
  - ding_profit.php: 利润钉钉通知

- **scripts/**: 脚本文件
  - process_images_worker.php: 图像处理脚本

- **开发日志/**: 开发日志文件

#### ebayfast/
Ebay 快捷工具，包含 JavaScript 脚本：

- ebayfast.js: 主脚本
- ebayfastpre.latest.js: 最新预发布版本
- ebayfastpre.min.js: 压缩版本
- 其他版本的脚本文件

#### lingxing.com/
领星 ERP API 相关文件：

- API.docx: API 文档
- 各种 JSON 数据文件：订单、商品、库存等数据
- JavaScript 脚本：抓取订单、获取订单信息等
- Markdown 文档：API 设置说明

#### xlingxing/
领星 API 集成代码：

- **php/**: PHP 版本的 API 客户端
  - lx_openapi/: 领星开放 API SDK
  - 各种 PHP 脚本：获取库存、订单、产品等数据
  - Python 脚本：数据处理和同步

## 4. 架构模式

### MVC 架构

项目采用经典的 MVC (Model-View-Controller) 架构模式：

- **Model**: 负责数据访问和业务逻辑
- **View**: 负责页面渲染和用户界面
- **Controller**: 负责处理请求、协调 Model 和 View

### 请求处理流程

1. 用户发起 HTTP 请求 (如访问 login.php)
2. 入口文件加载配置和控制器
3. 控制器处理请求，调用相应的模型获取数据
4. 控制器将数据传递给视图
5. 视图渲染页面并返回给用户

### 数据库访问模式

采用单例模式实现数据库连接：

```php
class Database {
    private static $instance = null;
    private $conn;
    
    private function __construct() {
        try {
            $this->conn = new PDO(
                "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8",
                DB_USER,
                DB_PASS,
                [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false
                ]
            );
        } catch(PDOException $e) {
            die("数据库连接失败: " . $e->getMessage());
        }
    }
    
    public static function getInstance() {
        if(self::$instance === null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }
    
    // 其他数据库操作方法...
}
```

### 缓存机制

项目实现了 Redis 缓存机制，用于提升页面加载速度：

- **单例模式**: RedisCache 类采用单例模式
- **缓存键设计**: 包含日期前缀，确保数据定期更新
- **过期策略**: 设置合理的缓存过期时间
- **降级处理**: Redis 连接失败时自动降级为直接查询数据库

## 5. 核心功能模块

### 5.1 用户认证系统

- **登录/登出**: 基于 Session 的用户认证
- **密码安全**: 使用 password_hash() 进行密码加密
- **会话管理**: 会话超时控制

### 5.2 RBAC 权限管理

- **角色管理**: 定义不同的角色 (admin, editor, viewer)
- **权限管理**: 细粒度的权限控制
- **用户-角色-权限关系**: 多对多关系管理

### 5.3 订单利润管理

- **订单数据导入**: 从外部系统导入订单
- **利润计算**: 自动计算订单利润
- **利润统计**: 按时间、店铺、商品统计利润
- **多维度分析**: 提供多种利润分析视图

### 5.4 库存管理

- **库存明细**: 实时库存数据管理
- **库存预警**: 低库存提醒
- **库龄管理**: 库存周转分析
- **FBA库存管理**: 亚马逊 FBA 库存专门管理

### 5.5 产品管理

- **商品 CRUD**: 创建、读取、更新、删除商品
- **批量导入/导出**: 支持 CSV 格式批量操作
- **商品搜索与筛选**: 多条件搜索和过滤
- **商品统计**: 分类、状态、品牌统计
- **新产品开发**: 跟踪新产品开发进度

### 5.6 费用管理

- **公司费用**: 公司运营费用管理
- **店铺费用**: 店铺相关费用管理
- **赛道费用**: 广告赛道费用管理
- **订单其他费用**: 订单相关的其他费用管理

### 5.7 数据仪表盘

- **关键指标可视化**: 销售、利润、库存等关键指标图表
- **业务数据概览**: 提供全面的业务数据概览
- **实时数据**: 展示最新的业务数据

### 5.8 外部系统集成

- **领星 ERP**: 订单、商品、库存数据同步
- **钉钉通知**: 库存预警、利润提醒等通知

### 5.9 辅助功能

- **车型数据库**: 汽车车型数据管理
- **运费管理**: 物流运费记录和管理
- **店铺管理**: 电商店铺信息管理
- **仓库管理**: 仓库信息和库存管理
- **AI生成功能**: 利用 AI 生成内容
- **查询功能**: 提供多种数据查询工具

## 6. 数据库设计

### 6.1 核心数据表

#### 用户相关
- **users**: 用户信息表
- **roles**: 角色表
- **permissions**: 权限表
- **user_roles**: 用户-角色关联表
- **role_permissions**: 角色-权限关联表

#### 业务相关
- **products**: 商品表
- **inventory_details**: 库存明细表
- **inventory_details_fba**: FBA库存明细表
- **order_profit**: 订单利润表
- **order_other_costs**: 订单其他费用表
- **company_costs**: 公司费用表
- **shop_costs**: 店铺费用表
- **track_costs**: 赛道费用表
- **new_products**: 新产品开发表
- **car_data**: 车型数据表
- **store**: 店铺表
- **warehouse**: 仓库表
- **yunfei**: 运费表

### 6.2 数据库关系图

```
┌─────────┐     ┌─────────┐     ┌──────────────┐
│  users  │────▶│  roles  │────▶│ permissions  │
└─────────┘     └─────────┘     └──────────────┘
       │             │                   │
       │             ▼                   ▼
       │       ┌────────────┐     ┌───────────────┐
       │       │user_roles  │     │role_permissions│
       │       └────────────┘     └───────────────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────┐
│ products     │────▶│inventory_details│────▶│warehouses│
└──────────────┘     └──────────────┘     └──────────┘
       │                    │
       │                    ▼
       │            ┌──────────────────┐
       │            │inventory_details_fba│
       │            └──────────────────┘
       │
       ▼
┌──────────────┐     ┌──────────┐     ┌──────────────┐
│order_profit  │────▶│   store  │◀────│   yunfei     │
└──────────────┘     └──────────┘     └──────────────┘
       │                    │
       │                    ▼
       │            ┌──────────────┐
       │            │car_data      │
       │            └──────────────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐
│company_costs │     │shop_costs    │
└──────────────┘     └──────────────┘
       │                    │
       ▼                    ▼
┌──────────────┐     ┌──────────────┐
│track_costs   │     │new_products  │
└──────────────┘     └──────────────┘
```

### 6.3 数据结构特点

- **JSON 支持**: 使用 JSON 类型存储复杂数据结构
- **外键约束**: 建立完整的关系约束
- **索引优化**: 关键字段建立索引提升查询性能
- **数据完整性**: 定义了适当的字段类型和约束

## 7. 认证与授权机制

### 7.1 认证流程

1. 用户提交登录表单
2. 控制器验证用户名和密码
3. 验证通过后创建会话
4. 后续请求通过会话验证用户身份

### 7.2 授权流程

1. 用户发起请求
2. 控制器检查用户是否登录
3. 检查用户是否拥有所需权限
4. 有权限则处理请求，否则返回错误信息

### 7.3 权限检查示例

```php
// 检查用户是否有创建商品的权限
if (!hasPermission('products.create')) {
    showError('您没有权限创建商品');
    redirect(APP_URL . '/products.php');
}
```

## 8. 数据流

### 8.1 用户认证数据流

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐
│  用户   │────▶│ login.php   │────▶│AuthController│────▶│ 模型层  │
└─────────┘     └─────────────┘     └─────────────┘     └─────────┘
                     │                      │
                     ▼                      ▼
                ┌─────────────┐     ┌─────────────┐
                │  视图层     │◀────│  会话管理   │
                └─────────────┘     └─────────────┘
```

### 8.2 业务数据数据流

```
┌─────────┐     ┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│  用户   │────▶│ 业务页面    │────▶│  业务控制器     │────▶│  业务模型   │
└─────────┘     └─────────────┘     └─────────────────┘     └─────────────┘
                     │                           │
                     │                           ▼
                     │                    ┌─────────────┐
                     │                    │  缓存层     │
                     │                    └─────────────┘
                     │                           │
                     ▼                           │
                ┌─────────────┐     ┌─────────────┐
                │  视图层     │◀────│  数据库    │
                └─────────────┘     └─────────────┘
```

### 8.3 外部系统集成数据流

```
┌────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 外部 API  │────▶│ API 客户端  │────▶│  模型层     │────▶│  数据库    │
└────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                     │                           │
                     │                           │
                     ▼                           ▼
                ┌─────────────┐     ┌─────────────┐
                │  钉钉通知   │◀────│  业务逻辑   │
                └─────────────┘     └─────────────┘
```

## 9. 性能优化

### 9.1 数据库优化

- **索引优化**: 关键字段建立索引提升查询性能
- **分页查询**: 数据列表采用分页加载
- **批量操作**: 支持批量导入/导出

### 9.2 缓存优化

- **Redis 缓存**: 使用 Redis 缓存减少数据库查询
- **智能缓存策略**: 针对不同数据类型设置不同的缓存策略
- **自动过期**: 缓存数据自动过期，确保数据新鲜度
- **缓存降级**: Redis 连接失败时自动降级为直接查询数据库

### 9.3 前端优化

- **资源压缩**: CSS/JS 文件压缩
- **图表渲染优化**: 动态设置 Canvas 尺寸，解决模糊拉伸问题
- **响应式设计**: 适配不同屏幕尺寸

## 10. 安全考虑

### 10.1 输入验证

- **表单验证**: 服务器端表单验证
- **参数过滤**: 防止 SQL 注入
- **XSS 防护**: 输出转义

### 10.2 权限控制

- **RBAC 权限管理**: 细粒度的权限控制
- **URL 访问控制**: 控制器层面的权限检查
- **敏感操作日志**: 关键操作记录

### 10.3 数据安全

- **密码加密**: 使用 password_hash() 加密
- **会话安全**: 会话 ID 保护
- **HTTPS 支持**: 可配置 HTTPS

## 11. 部署与维护

### 11.1 安装步骤

1. **创建数据库**: 创建 MySQL 数据库
2. **导入数据**: 导入 `database/init.sql` 脚本
3. **配置文件**: 修改 `includes/database.php` 中的数据库连接信息
4. **部署项目**: 将项目部署到 Web 服务器
5. **访问项目**: 通过浏览器访问登录页面

### 11.2 默认账号

- **用户名**: admin
- **密码**: password

### 11.3 维护建议

- **定期备份**: 定期备份数据库
- **日志监控**: 监控服务器日志
- **安全更新**: 及时更新 PHP 和数据库版本
- **代码维护**: 遵循项目代码规范
- **性能监控**: 定期检查系统性能，优化慢查询

## 12. 扩展性考虑

### 12.1 模块化设计

项目采用模块化的设计，每个功能模块相对独立，便于扩展和维护：

- **控制器模块化**: 每个业务功能有独立的控制器
- **模型模块化**: 每个数据实体有独立的模型
- **视图模块化**: 按功能模块组织视图文件

### 12.2 API 集成

项目设计了灵活的 API 集成机制，可以方便地对接外部系统：

- **领星 ERP API**: 已实现 PHP 和 Python 两种版本
- **物流 API**: 支持运费查询和物流跟踪

### 12.3 未来扩展

- **框架迁移**: 考虑迁移到现代化 PHP 框架 (如 Laravel、Symfony)
- **前端现代化**: 使用 Vue.js/React 等现代前端框架
- **API 接口**: 提供 RESTful API 接口
- **微服务架构**: 考虑拆分为微服务架构
- **容器化部署**: 使用 Docker 容器化部署

## 13. 总结与展望

### 13.1 项目优势

- **架构清晰**: 采用 MVC 架构，代码结构清晰
- **功能完整**: 实现了完整的业务功能
- **扩展性强**: 模块化设计，便于扩展
- **易于维护**: 代码规范，文档完善
- **性能优化**: 引入缓存机制，提升系统性能
- **安全可靠**: 实现了完整的认证和权限管理

### 13.2 改进方向

- **技术栈升级**: 考虑使用现代化的技术栈
- **前端体验**: 提升前端用户体验，实现更丰富的交互效果
- **API 能力**: 增强 API 接口能力，支持更多外部系统集成
- **数据分析**: 引入更强大的数据分析工具，提供更深入的业务洞察
- **自动化运维**: 实现更完善的自动化运维工具

---

**文档创建时间**: 2026-01-22
**文档版本**: 2.0
**文档作者**: 自动生成