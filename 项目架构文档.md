# 项目架构文档

## 1. 项目概述

本项目是一个基于原生 PHP 开发的后端管理平台，主要用于汽车零部件相关业务的管理，包括商品管理、库存管理、订单利润分析、运费管理等功能。项目采用了 MVC 架构模式，实现了完整的用户认证和 RBAC 权限管理系统。

## 2. 技术栈

### 后端
- **编程语言**: 原生 PHP (无框架)
- **数据库**: MySQL 5.7+
- **ORM**: 自定义简单 ORM (基于 PDO)
- **认证**: 基于会话 (Session) 的认证
- **权限管理**: RBAC (基于角色的访问控制)

### 前端
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **JavaScript**: 客户端交互
- **Bootstrap 5**: UI 框架
- **Font Awesome**: 图标库

### 开发工具与环境
- **开发环境**: Windows
- **Web 服务器**: Apache/Nginx
- **数据库管理**: phpMyAdmin/MySQL Workbench

## 3. 目录结构

项目采用模块化的目录结构，主要分为以下几个部分：

```
cz.younger-car.com/
├── admin-panel/           # 管理面板主目录
│   ├── config/           # 配置文件
│   ├── controllers/      # 控制器层
│   ├── models/           # 模型层
│   ├── views/            # 视图层
│   ├── helpers/          # 辅助函数
│   ├── includes/         # 包含文件
│   ├── database/         # 数据库脚本
│   └── public/           # 公共资源
├── ebayfast/             # eBay 快捷工具
├── lingxing.com/         # 领星 ERP API 相关
├── xlingxing/            # 领星 API 集成
│   ├── php/              # PHP 实现
│   └── python/           # Python 实现
└── yunfei_kucun/         # 运费和库存相关 API
```

### 核心目录详解

#### admin-panel/
管理面板的核心目录，采用 MVC 架构：

- **config/**: 项目配置文件，包括数据库连接、应用设置等
- **controllers/**: 控制器层，处理 HTTP 请求和业务逻辑
  - AuthController.php: 处理用户认证
  - ProductsController.php: 商品管理
  - InventoryDetailsController.php: 库存明细管理
  - OrderProfitController.php: 订单利润管理
  - 其他业务控制器...
- **models/**: 模型层，处理数据访问和业务实体
  - User.php: 用户模型
  - Product.php: 商品模型
  - InventoryDetails.php: 库存明细模型
  - OrderProfit.php: 订单利润模型
  - 其他业务模型...
- **views/**: 视图层，负责页面渲染
  - auth/: 认证相关视图
  - products/: 商品管理视图
  - inventory_details/: 库存明细视图
  - layouts/: 页面布局模板
  - 其他业务视图...
- **helpers/**: 辅助函数库
- **includes/**: 通用包含文件，如数据库连接
- **database/**: 数据库初始化和更新脚本
- **public/**: 静态资源文件 (CSS, JS, 图片等)

#### xlingxing/
与领星 ERP 系统集成的代码：

- **php/**: PHP 版本的 API 客户端
- **python/**: Python 版本的 API 客户端

#### yunfei_kucun/
运费查询和库存管理相关的外部 API 集成：

- **api_ems/**: EMS 物流 API 集成
- **api_wd/**: 运德物流 API 集成

## 4. 架构模式

### MVC 架构

项目采用经典的 MVC (Model-View-Controller) 架构模式：

- **Model**: 负责数据访问和业务逻辑
- **View**: 负责页面渲染和用户界面
- **Controller**: 负责处理请求、协调 Model 和 View

### 请求处理流程

1. 用户发起 HTTP 请求 (如访问 login.php)
2. 入口文件加载配置和控制器
3. 控制器处理请求，调用相应的模型获取数据
4. 控制器将数据传递给视图
5. 视图渲染页面并返回给用户

### 数据库访问模式

采用单例模式实现数据库连接：

```php
class Database {
    private static $instance = null;
    private $conn;
    
    private function __construct() {
        // 创建数据库连接
    }
    
    public static function getInstance() {
        if(self::$instance === null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }
    
    // 其他数据库操作方法
}
```

## 5. 核心功能模块

### 5.1 用户认证系统

- **登录/登出**: 基于 Session 的用户认证
- **密码安全**: 使用 password_hash() 进行密码加密
- **会话管理**: 会话超时控制

### 5.2 RBAC 权限管理

- **角色管理**: 定义不同的角色 (admin, editor, viewer)
- **权限管理**: 细粒度的权限控制
- **用户-角色-权限关系**: 多对多关系管理

### 5.3 商品管理

- **商品 CRUD**: 创建、读取、更新、删除商品
- **批量导入/导出**: 支持 CSV 格式批量操作
- **商品搜索与筛选**: 多条件搜索和过滤
- **商品统计**: 分类、状态、品牌统计

### 5.4 库存管理

- **库存明细**: 实时库存数据管理
- **库存预警**: 低库存提醒
- **库龄管理**: 库存周转分析

### 5.5 订单利润管理

- **订单数据导入**: 从外部系统导入订单
- **利润计算**: 自动计算订单利润
- **利润统计**: 按时间、店铺、商品统计利润

### 5.6 运费管理

- **运费查询**: 对接外部物流 API 查询运费
- **运费记录**: 存储和管理运费信息

### 5.7 外部系统集成

- **领星 ERP**: 订单、商品、库存数据同步
- **物流 API**: 运费查询和物流跟踪

## 6. 数据库设计

### 6.1 核心数据表

#### 用户相关
- **users**: 用户信息表
- **roles**: 角色表
- **permissions**: 权限表
- **user_roles**: 用户-角色关联表
- **role_permissions**: 角色-权限关联表

#### 业务相关
- **products**: 商品表
- **inventory_details**: 库存明细表
- **order_profit**: 订单利润表
- **yunfei**: 运费表
- **new_products**: 新产品开发表
- **warehouses**: 仓库表
- **store**: 店铺表

### 6.2 数据库关系图

```
┌─────────┐     ┌─────────┐     ┌──────────────┐
│  users  │────▶│  roles  │────▶│ permissions  │
└─────────┘     └─────────┘     └──────────────┘
       │             │                   │
       │             ▼                   ▼
       │       ┌────────────┐     ┌───────────────┐
       │       │user_roles  │     │role_permissions│
       │       └────────────┘     └───────────────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────┐
│ products     │────▶│inventory_details│────▶│warehouses│
└──────────────┘     └──────────────┘     └──────────┘
       │
       ▼
┌──────────────┐     ┌──────────┐
│order_profit  │────▶│   store  │
└──────────────┘     └──────────┘
       │
       ▼
┌──────────────┐
│   yunfei     │
└──────────────┘
```

### 6.3 数据结构特点

- **JSON 支持**: 使用 JSON 类型存储复杂数据结构
- **外键约束**: 建立完整的关系约束
- **索引优化**: 关键字段建立索引提升查询性能
- **数据完整性**: 定义了适当的字段类型和约束

## 7. 认证与授权机制

### 7.1 认证流程

1. 用户提交登录表单
2. 控制器验证用户名和密码
3. 验证通过后创建会话
4. 后续请求通过会话验证用户身份

### 7.2 授权流程

1. 用户发起请求
2. 控制器检查用户是否登录
3. 检查用户是否拥有所需权限
4. 有权限则处理请求，否则返回错误信息

### 7.3 权限检查示例

```php
// 检查用户是否有创建商品的权限
if (!hasPermission('products.create')) {
    showError('您没有权限创建商品');
    redirect(APP_URL . '/products.php');
}
```

## 8. 数据流

### 8.1 用户认证数据流

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐
│  用户   │────▶│ login.php   │────▶│AuthController│────▶│ 模型层  │
└─────────┘     └─────────────┘     └─────────────┘     └─────────┘
                     │                      │
                     ▼                      ▼
                ┌─────────────┐     ┌─────────────┐
                │  视图层     │◀────│  会话管理   │
                └─────────────┘     └─────────────┘
```

### 8.2 商品管理数据流

```
┌─────────┐     ┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│  用户   │────▶│products.php │────▶│ProductsController│────▶│ProductsModel│
└─────────┘     └─────────────┘     └─────────────────┘     └─────────────┘
                     │                           │
                     ▼                           ▼
                ┌─────────────┐     ┌─────────────┐
                │  视图层     │◀────│  数据库    │
                └─────────────┘     └─────────────┘
```

### 8.3 外部系统集成数据流

```
┌────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 外部 API  │────▶│ API 客户端  │────▶│  模型层     │────▶│  数据库    │
└────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 9. 核心代码分析

### 9.1 数据库连接 (单例模式)

```php
class Database {
    private static $instance = null;
    private $conn;
    
    private function __construct() {
        try {
            $this->conn = new PDO(
                "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8",
                DB_USER,
                DB_PASS,
                [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false
                ]
            );
        } catch(PDOException $e) {
            die("数据库连接失败: " . $e->getMessage());
        }
    }
    
    public static function getInstance() {
        if(self::$instance === null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }
    
    // 其他数据库操作方法...
}
```

### 9.2 用户认证控制器

```php
class AuthController {
    private $userModel;
    
    public function __construct() {
        $this->userModel = new User();
        session_start();
    }
    
    // 显示登录页面
    public function login() {
        if (isLoggedIn()) {
            redirect(APP_URL . '/dashboard.php');
        }
        
        $error = getError();
        include VIEWS_DIR . '/auth/login.php';
    }
    
    // 处理登录请求
    public function loginPost() {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            redirect(APP_URL . '/login.php');
        }
        
        $username = $_POST['username'] ?? '';
        $password = $_POST['password'] ?? '';
        
        // 验证用户名和密码
        $user = $this->userModel->verifyLogin($username, $password);
        if (!$user) {
            showError('用户名或密码错误');
            redirect(APP_URL . '/login.php');
        }
        
        // 设置会话
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['full_name'] = $user['full_name'];
        
        showSuccess('登录成功');
        redirect(APP_URL . '/dashboard.php');
    }
}
```

### 9.3 权限检查函数

```php
// 检查用户是否有指定权限
function hasPermission($permissionSlug) {
    if (!isLoggedIn()) {
        return false;
    }
    
    require_once APP_ROOT . '/models/Permission.php';
    $permissionModel = new Permission();
    return $permissionModel->checkUserPermission(getCurrentUserId(), $permissionSlug);
}
```

## 10. 扩展性考虑

### 10.1 模块化设计

项目采用模块化的设计，每个功能模块相对独立，便于扩展和维护：

- **控制器模块化**: 每个业务功能有独立的控制器
- **模型模块化**: 每个数据实体有独立的模型
- **视图模块化**: 按功能模块组织视图文件

### 10.2 API 集成

项目设计了灵活的 API 集成机制，可以方便地对接外部系统：

- **领星 ERP API**: 已实现 PHP 和 Python 两种版本
- **物流 API**: 支持 EMS、运德等物流接口

### 10.3 性能优化

- **数据库索引**: 关键字段建立索引
- **分页查询**: 数据列表采用分页加载
- **批量操作**: 支持批量导入/导出
- **缓存机制**: 可扩展的缓存支持 (未实现)

## 11. 安全考虑

### 11.1 输入验证

- **表单验证**: 服务器端表单验证
- **参数过滤**: 防止 SQL 注入
- **XSS 防护**: 输出转义

### 11.2 权限控制

- **RBAC 权限管理**: 细粒度的权限控制
- **URL 访问控制**: 控制器层面的权限检查
- **敏感操作日志**: 关键操作记录 (未实现)

### 11.3 数据安全

- **密码加密**: 使用 password_hash() 加密
- **会话安全**: 会话 ID 保护
- **HTTPS 支持**: 可配置 HTTPS (未实现)

## 12. 部署与维护

### 12.1 安装步骤

1. **创建数据库**: 创建 MySQL 数据库
2. **导入数据**: 导入 `database/init.sql` 脚本
3. **配置文件**: 修改 `config/config.php` 中的数据库连接信息
4. **部署项目**: 将项目部署到 Web 服务器
5. **访问项目**: 通过浏览器访问登录页面

### 12.2 默认账号

- **用户名**: admin
- **密码**: password

### 12.3 维护建议

- **定期备份**: 定期备份数据库
- **日志监控**: 监控服务器日志
- **安全更新**: 及时更新 PHP 和数据库版本
- **代码维护**: 遵循项目代码规范

## 13. 总结与展望

### 13.1 项目优势

- **架构清晰**: 采用 MVC 架构，代码结构清晰
- **功能完整**: 实现了完整的业务功能
- **扩展性强**: 模块化设计，便于扩展
- **易于维护**: 代码规范，文档完善

### 13.2 改进方向

- **框架迁移**: 考虑迁移到现代化 PHP 框架 (如 Laravel、Symfony)
- **前端现代化**: 使用 Vue.js/React 等现代前端框架
- **API 接口**: 提供 RESTful API 接口
- **缓存机制**: 增加缓存层提升性能
- **日志系统**: 完善的日志记录和分析
- **测试覆盖**: 增加单元测试和集成测试

---

**文档创建时间**: " . date('Y-m-d') . "
**文档版本**: 1.0
**文档作者**: 自动生成